<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Yahtzee Online:></title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ecf0f1;
            --accent-color: #e67e22;
            --confirm-color: #27ae60;
            --secondary-bg: #2c3e50;
            --die-size: 42px;
            --dot-color: #000;
            --die-base-color: #fff;
            --admin-color: #9b59b6;
            --info-color: #3498db;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .view-section {
            width: 100%;
            max-width: 600px;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-bottom: 50px;
        }
        
        .active-view { display: flex; }

        h1 { margin: 5px 0 10px 0; color: var(--accent-color); font-size: 1.5rem; }
        h2 { margin: 5px 0; font-size: 1.2rem; color: #bdc3c7; }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80%;
            margin-top: 20px;
        }
        
        .menu-btn {
            background: var(--secondary-bg);
            color: white;
            border: 2px solid var(--accent-color);
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .menu-btn:active { transform: scale(0.98); }
        .menu-btn.primary { background: var(--accent-color); border-color: #d35400; }
        .menu-btn.info { background: var(--info-color); border-color: #2980b9; }
        
        /* ç®¡ç†å“¡æŒ‰éˆ•æ¨£å¼ */
        .menu-btn.admin-btn {
            background: var(--admin-color);
            border-color: #8e44ad;
            display: none;
        }
        .menu-btn.admin-btn.visible { display: block; }
        .admin-controls-area { border: 1px dashed var(--admin-color); padding: 10px; border-radius: 8px; margin: 10px 0; width: 90%; display:none;}
        .admin-controls-area.active { display: flex; flex-direction: column; gap: 5px; }

        input[type="text"], input[type="number"], input[type="password"] {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            width: 80%;
            margin-bottom: 10px;
            text-align: center;
        }

        .room-list {
            width: 100%;
            background: #222;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .room-item {
            background: #333;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-item.leaderboard-item {
            display: grid;
            grid-template-columns: 1fr 60px 60px; /* Name, Score, Action */
            gap: 5px;
            text-align: left;
        }
        /* ç®¡ç†å“¡è©³ç´°å¡ç‰‡æ¨£å¼ */
        .admin-room-card {
            background: #2a2a2a;
            border-left: 4px solid var(--admin-color);
            padding: 10px;
            margin-bottom: 10px;
            text-align: left;
            border-radius: 4px;
        }
        
        .room-status { font-size: 0.8rem; color: #aaa; }
        
        .action-btn {
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .join-btn { background: var(--confirm-color); }
        .view-btn { background: var(--info-color); }
        .delete-btn { background: #c0392b; margin-left: 5px;}
        .warn-btn { background: #d35400; margin-left: 5px; }

        /* Dice & Game Styles */
        .dice-board {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
            perspective: 600px;
            height: var(--die-size);
        }

        .cube-wrapper { width: var(--die-size); height: var(--die-size); cursor: pointer; }
        .cube {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transform: rotateX(0deg) rotateY(0deg);
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .face {
            position: absolute; width: var(--die-size); height: var(--die-size);
            background: var(--die-base-color); border: 1px solid #999;
            border-radius: 6px; box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr);
            padding: 4px; 
            box-sizing: border-box;
            gap: 2px;
        }
        .dot {
            background-color: var(--dot-color); 
            border-radius: 50%;
            width: 100%; 
            height: 100%;
            display: block;
        }
        
        /* Dice Faces Logic */
        .face-1 .dot:nth-child(1) { grid-area: 2 / 2; }
        .face-2 .dot:nth-child(1) { grid-area: 1 / 1; } .face-2 .dot:nth-child(2) { grid-area: 3 / 3; }
        .face-3 .dot:nth-child(1) { grid-area: 1 / 1; } .face-3 .dot:nth-child(2) { grid-area: 2 / 2; } .face-3 .dot:nth-child(3) { grid-area: 3 / 3; }
        .face-4 .dot:nth-child(1) { grid-area: 1 / 1; } .face-4 .dot:nth-child(2) { grid-area: 1 / 3; } .face-4 .dot:nth-child(3) { grid-area: 3 / 1; } .face-4 .dot:nth-child(4) { grid-area: 3 / 3; }
        .face-5 .dot:nth-child(1) { grid-area: 1 / 1; } .face-5 .dot:nth-child(2) { grid-area: 1 / 3; } .face-5 .dot:nth-child(3) { grid-area: 2 / 2; } .face-5 .dot:nth-child(4) { grid-area: 3 / 1; } .face-5 .dot:nth-child(5) { grid-area: 3 / 3; }
        .face-6 .dot:nth-child(1) { grid-area: 1 / 1; } .face-6 .dot:nth-child(2) { grid-area: 1 / 3; } .face-6 .dot:nth-child(3) { grid-area: 2 / 1; } .face-6 .dot:nth-child(4) { grid-area: 2 / 3; } .face-6 .dot:nth-child(5) { grid-area: 3 / 1; } .face-6 .dot:nth-child(6) { grid-area: 3 / 3; }

        .locked .face { border-color: #e74c3c; background-color: #ffe6e6; box-shadow: 0 0 8px #e74c3c; }
        .locked .dot { background-color: #c0392b; }
        
        .front { transform: rotateY(0deg) translateZ(21px); }
        .back { transform: rotateY(180deg) translateZ(21px); }
        .right { transform: rotateY(90deg) translateZ(21px); }
        .left { transform: rotateY(-90deg) translateZ(21px); }
        .top { transform: rotateX(90deg) translateZ(21px); }
        .bottom { transform: rotateX(-90deg) translateZ(21px); }

        .controls { margin-bottom: 10px; display: flex; justify-content: center; gap: 10px; }
        button { color: white; border: none; padding: 8px 16px; font-size: 0.95rem; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        #roll-btn { background: var(--accent-color); box-shadow: 0 3px 0 #d35400; }
        #confirm-btn { background: var(--confirm-color); box-shadow: 0 3px 0 #1e8449; }
        #quit-btn { background: #c0392b; box-shadow: 0 3px 0 #922b21; }
        button:active { transform: translateY(3px); box-shadow: none !important; }
        button:disabled { background: #7f8c8d !important; box-shadow: none !important; transform: none !important; opacity: 0.7; cursor: not-allowed; }

        .score-board { display: flex; gap: 4px; justify-content: center; align-items: flex-start; width: 100%; max-width: 800px; }
        .column { flex: 1; background: var(--secondary-bg); padding: 2px; border-radius: 6px; overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th.player-header {
            font-size: 0.7rem; color: #aaa; text-align: center; 
            padding: 4px 0; border-bottom: 1px solid #555;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        th.player-header.is-me-header { color: #3498db; font-weight: bold; }
        td { padding: 4px 1px; border-bottom: 1px solid #444; vertical-align: middle; font-size: 0.8rem; }
        tr.score-row { height: 32px; transition: background 0.2s; cursor: pointer; }
        tr.score-row.selected-row { background: rgba(39, 174, 96, 0.4); border: 1px solid #2ecc71; }
        .score-cell { 
            font-family: 'Courier New', monospace; font-weight: bold; 
            text-align: center; border-left: 1px solid #444; 
            color: #ecf0f1;
        }
        .score-cell.my-cell { background: rgba(52, 152, 219, 0.05); } 
        .preview-text { color: #f1c40f; font-style: italic; }
        .filled { color: #2ecc71; pointer-events: none; }
        td.icon-col { width: 35px; text-align: center; }
        
        /* Mini Dice Icons */
        .mini-die { 
            width: 16px; height: 16px; background: white; border-radius: 3px; 
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); 
            padding: 1px; margin: 0 auto; gap: 0.5px; box-sizing: border-box;
        }
        .mini-dot { background: black; border-radius: 50%; width: 100%; height: 100%; }
        .m-d-1 :nth-child(1) { grid-area: 2 / 2; }
        .m-d-2 :nth-child(1) { grid-area: 1 / 1; } .m-d-2 :nth-child(2) { grid-area: 3 / 3; }
        .m-d-3 :nth-child(1) { grid-area: 1 / 1; } .m-d-3 :nth-child(2) { grid-area: 2 / 2; } .m-d-3 :nth-child(3) { grid-area: 3 / 3; }
        .m-d-4 :nth-child(1) { grid-area: 1 / 1; } .m-d-4 :nth-child(2) { grid-area: 1 / 3; } .m-d-4 :nth-child(3) { grid-area: 3 / 1; } .m-d-4 :nth-child(4) { grid-area: 3 / 3; }
        .m-d-5 :nth-child(1) { grid-area: 1 / 1; } .m-d-5 :nth-child(2) { grid-area: 1 / 3; } .m-d-5 :nth-child(3) { grid-area: 2 / 2; } .m-d-5 :nth-child(4) { grid-area: 3 / 1; } .m-d-5 :nth-child(5) { grid-area: 3 / 3; }
        .m-d-6 :nth-child(1) { grid-area: 1 / 1; } .m-d-6 :nth-child(2) { grid-area: 1 / 3; } .m-d-6 :nth-child(3) { grid-area: 2 / 1; } .m-d-6 :nth-child(4) { grid-area: 2 / 3; } .m-d-6 :nth-child(5) { grid-area: 3 / 1; } .m-d-6 :nth-child(6) { grid-area: 3 / 3; }
        .symbol-text { font-size: 0.8rem; font-weight: 800; color: #bdc3c7; }
        
        #grand-total-display { font-size: 1.2rem; color: #f1c40f; margin-top: 10px; font-weight: bold; padding: 10px; background: #222; border-radius: 6px; }

        @media (max-width: 360px) {
            :root { --die-size: 38px; }
            .front { transform: rotateY(0deg) translateZ(19px); } .back { transform: rotateY(180deg) translateZ(19px); }
            .right { transform: rotateY(90deg) translateZ(19px); } .left { transform: rotateY(-90deg) translateZ(19px); }
            .top { transform: rotateX(90deg) translateZ(19px); } .bottom { transform: rotateX(-90deg) translateZ(19px); }
        }

        /* Overlay & Special Effects */
        #special-event-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; pointer-events: none; 
        }
        #special-event-overlay.active { display: flex; pointer-events: auto; }
        .rainbow-bg {
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 1800% 1800%; animation: rainbow-anim 2s ease infinite;
        }
        @keyframes rainbow-anim { 0% {background-position:0% 82%} 50% {background-position:100% 19%} 100% {background-position:0% 82%} }
        .cheer-text { font-size: 3rem; font-weight: 900; color: #fff; text-transform: uppercase; text-align: center; animation: pulse-text 0.5s infinite alternate; text-shadow: 0 4px 10px rgba(0,0,0,0.5); margin: 0 20px; line-height: 1.2; }
        .sub-cheer { color: white; margin-top: 20px; font-size: 1.5rem; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.5); text-align: center; }
        .confetti { position: absolute; width: 10px; height: 10px; background: #e74c3c; animation: fall linear forwards; z-index: 3001; }
        @keyframes pulse-text { from { transform: scale(1); } to { transform: scale(1.1); } }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* Admin & Players Bar */
        .players-bar { display: flex; width: 100%; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .player-badge { background: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; white-space: nowrap; border: 2px solid transparent; opacity: 0.7; }
        .player-badge.active-turn { border-color: var(--accent-color); background: #444; opacity: 1; font-weight: bold; }
        .player-badge.is-me { color: #3498db; }
        
        #admin-panel { display: none; margin-top: 15px; padding: 10px; background: #2c3e50; border: 2px solid var(--admin-color); border-radius: 8px; flex-direction: column; align-items: center; width: 90%; max-width: 400px; }
        #admin-panel.active { display: flex; }
        .admin-dice-inputs { display: flex; gap: 5px; margin-bottom: 5px; }
        .admin-die-input { width: 30px !important; padding: 5px !important; margin: 0 !important; text-align: center; }

        /* Tutorial & Text */
        .tutorial-content { text-align: left; background: #333; padding: 15px; border-radius: 8px; font-size: 0.9rem; line-height: 1.5; height: 350px; overflow-y: auto; width: 90%; }
        .tutorial-content h3 { color: var(--accent-color); border-bottom: 1px solid #555; padding-bottom: 5px; }
        .tutorial-content ul { padding-left: 20px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box { background: #222; padding: 20px; border-radius: 8px; width: 80%; max-width: 300px; text-align: center; border: 1px solid var(--accent-color); }
    </style>
</head>
<body>

    <div id="special-event-overlay">
        <div id="overlay-title" class="cheer-text"></div>
        <div id="overlay-sub" class="sub-cheer"></div>
    </div>

    <div id="landing-view" class="view-section active-view">
        <h1>ğŸ² 3D Yahtzee Pro</h1>
        <div class="btn-group">
            <button class="menu-btn primary" onclick="goToNickname()">é€£ç·šå°æˆ° (åŒ¹é…æ¨¡å¼)</button>
            <button class="menu-btn" onclick="showChallengeLobby()">æŒ‘æˆ°æ“‚å° (æ’è¡Œæ¦œ)</button>
            <button class="menu-btn" onclick="startSoloGame()">å–®äººç·´ç¿’ (Solo)</button>
            <button class="menu-btn info" onclick="showTutorial()">æŸ¥çœ‹éŠæˆ²è¦å‰‡</button>
            <button id="admin-entry-btn" class="menu-btn admin-btn" onclick="showAdminRoomManager()">ğŸ”´ æˆ¿é–“ç®¡ç† (yahtzee_rooms)</button>
        </div>
    </div>

    <div id="admin-room-view" class="view-section">
        <h1 style="color: var(--admin-color)">ğŸ”§ ç®¡ç†å“¡å¾Œå° (å¤šäºº)</h1>
        <div class="room-list" id="admin-room-list" style="max-height: 400px; background: transparent;"></div>
        <div class="btn-group">
            <button class="menu-btn" onclick="showView('landing-view')">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="nickname-view" class="view-section">
        <h1>è¼¸å…¥æš±ç¨±</h1>
        <input type="text" id="nickname-input" placeholder="ä¾‹å¦‚ï¼šéª°å­ç‹é˜¿æ˜" maxlength="8">
        <div class="btn-group">
            <button class="menu-btn primary" onclick="enterLobby()">é€²å…¥å¤§å»³</button>
            <button class="menu-btn" onclick="showView('landing-view')">è¿”å›</button>
        </div>
    </div>

    <div id="lobby-view" class="view-section">
        <h1>éŠæˆ²å¤§å»³</h1>
        <p>æ­¡è¿, <span id="lobby-nickname" style="color:var(--accent-color)"></span></p>
        <div style="width: 100%; margin: 10px 0;">
            <div style="display: flex; gap: 10px; justify-content: center; align-items: center; margin-bottom: 10px;">
                <label>äººæ•¸:</label>
                <select id="player-count-select" style="padding: 5px; border-radius: 4px;">
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                    <option value="4">4äºº</option>
                </select>
                <button class="action-btn join-btn" style="font-size:1rem; padding:8px;" onclick="createRoom()">å‰µç«‹æˆ¿é–“</button>
            </div>
            <div id="room-list-container" class="room-list"></div>
        </div>
        <button class="menu-btn" onclick="showView('landing-view')" style="margin-top: 20px; padding: 10px 20px;">é›¢é–‹</button>
    </div>

    <div id="waiting-view" class="view-section">
        <h1>ç­‰å¾…åŠ å…¥ä¸­...</h1>
        <p>æˆ¿é–“ ID: <span id="wait-room-id" style="color: #f1c40f; font-family: monospace;"></span></p>
        <p>ç©å®¶: <span id="wait-player-count">1</span> / <span id="wait-max-players">2</span></p>
        <div class="room-list" id="wait-player-list"></div>
        <div class="btn-group">
            <button id="host-start-btn" class="menu-btn primary" style="display:none;" onclick="manualStartGame()">é–‹å§‹éŠæˆ² (æ‰‹å‹•)</button>
            <button class="menu-btn" style="background:#c0392b; border-color:#922b21;" onclick="leaveWaitingRoom()">é›¢é–‹æˆ¿é–“</button>
        </div>
    </div>

    <div id="challenge-lobby-view" class="view-section">
        <h1>ğŸ† æŒ‘æˆ°æ“‚å°</h1>
        
        <div id="admin-challenge-controls" class="admin-controls-area">
            <h3 style="color:var(--admin-color); margin:0;">ç®¡ç†å“¡ï¼šå‰µå»ºæ“‚å°</h3>
            <input type="text" id="new-challenge-name" placeholder="æ“‚å°åç¨± (å¦‚: é€±æœ«ç›ƒ)" style="width:90%">
            <input type="text" id="new-challenge-pass" placeholder="å¯†ç¢¼ (ç©ºç™½ç‚ºå…¬é–‹)" style="width:90%">
            <button class="action-btn join-btn" onclick="createChallengeRoom()">å»ºç«‹</button>
        </div>

        <div class="room-list" id="challenge-room-list">
            <div style="padding:10px; color:#aaa;">è®€å–æ“‚å°ä¸­...</div>
        </div>
        
        <div class="btn-group">
            <button class="menu-btn" onclick="showView('landing-view')">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="challenge-room-detail" class="view-section">
        <h2 id="c-room-title">æ“‚å°è©³æƒ…</h2>
        <p style="font-size:0.8rem; color:#aaa;">ID: <span id="c-room-id"></span></p>
        
        <div class="room-list" id="c-leaderboard-list">
            </div>

        <div class="btn-group">
            <button class="menu-btn primary" onclick="promptChallengeStart()">âš”ï¸ æˆ‘è¦æŒ‘æˆ°</button>
            <button class="menu-btn" onclick="showChallengeLobby()">è¿”å›åˆ—è¡¨</button>
        </div>
    </div>

    <div id="tutorial-view" class="view-section">
        <h1>ğŸ“œ éŠæˆ²æ•™å­¸</h1>
        <div class="tutorial-content">
            <h3>éŠæˆ²ç›®æ¨™</h3>
            <p>æ“²éª°å­ä¸¦åœ¨è¨˜åˆ†æ¿ä¸Šç²å¾—æœ€é«˜åˆ†ã€‚éŠæˆ²å…± 13 å›åˆã€‚</p>
            <h3>å›åˆæµç¨‹</h3>
            <ul>
                <li>æ¯å›åˆæœ‰ 3 æ¬¡æ“²éª°æ©Ÿæœƒã€‚</li>
                <li>é»æ“Šéª°å­å¯ä»¥ã€Œé–å®š/è§£é–ã€ä¿ç•™é»æ•¸ã€‚</li>
                <li>ç¬¬ 3 æ¬¡æ“²éª°å¾Œï¼ˆæˆ–æå‰ï¼‰ï¼Œå¿…é ˆåœ¨è¨˜åˆ†æ¿é¸æ“‡ä¸€æ ¼å¡«åˆ†ã€‚</li>
            </ul>
            <h3>è¨ˆåˆ†è¦å‰‡ (å·¦åŠé‚Š)</h3>
            <p>å°æ‡‰é»æ•¸ç¸½å’Œã€‚è‹¥ä¸Šå±¤ç¸½åˆ† >= 63ï¼Œé¡å¤–ç²å¾— 35 åˆ†çå‹µã€‚</p>
            <h3>è¨ˆåˆ†è¦å‰‡ (å³åŠé‚Š)</h3>
            <ul>
                <li>3X (ä¸‰æ¢): 3é¡†ç›¸åŒï¼Œç¸½å’Œè¨ˆåˆ†ã€‚</li>
                <li>4X (å››æ¢): 4é¡†ç›¸åŒï¼Œç¸½å’Œè¨ˆåˆ†ã€‚</li>
                <li>ğŸ  (è‘«è˜†): 3åŒ+2åŒï¼Œå›ºå®š 25 åˆ†ã€‚</li>
                <li>å°é †: 4é€£è™Ÿï¼Œå›ºå®š 30 åˆ†ã€‚</li>
                <li>å¤§é †: 5é€£è™Ÿï¼Œå›ºå®š 40 åˆ†ã€‚</li>
                <li>Y! (Yahtzee): 5é¡†ç›¸åŒï¼Œå›ºå®š 50 åˆ†ã€‚</li>
                <li>? (æ©Ÿæœƒ): æ‰€æœ‰éª°å­ç¸½å’Œã€‚</li>
            </ul>
            <h3>ç‰¹æ®Šçå‹µ</h3>
            <p>è‹¥åœ¨æ“²å‡ºå¤šæ¬¡ Yahtzeeï¼Œä¸” Y! æ ¼å·²å¡«æ»¿ 50 åˆ†ï¼Œæ¯æ¬¡é¡å¤– +100 åˆ†ï¼</p>
        </div>
        <div class="btn-group">
            <button class="menu-btn" onclick="showView('landing-view')">æ˜ç™½ï¼Œé–‹å§‹ç©ï¼</button>
        </div>
    </div>

    <div id="game-view" class="view-section">
        <div class="players-bar" id="ingame-players-bar"></div>
        <div id="turn-indicator" style="background: #8e44ad; color: white; padding: 5px 15px; border-radius: 20px; margin-bottom: 10px;">å–®äººæ¨¡å¼</div>
        
        <div class="dice-board" id="dice-container"></div>

        <div class="controls" id="game-controls">
            <button id="roll-btn" onclick="handleRollClick()">æ“²éª° (<span id="rolls-left">3</span>)</button>
            <button id="confirm-btn" onclick="handleConfirmClick()" disabled>ç¢ºèª</button>
            <button id="quit-btn" onclick="quitGame()">é€€å‡º</button>
        </div>
        
        <div class="controls" id="record-controls" style="display:none;">
            <button class="menu-btn" onclick="exitRecordView()">é—œé–‰æŸ¥çœ‹</button>
        </div>

        <div id="admin-panel">
            <div style="color: #9b59b6; font-weight: bold; margin-bottom:5px;">ğŸ‘¾ God Mode</div>
            <div class="admin-dice-inputs">
                <input type="number" id="admin-d0" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d1" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d2" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d3" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d4" class="admin-die-input" min="1" max="6" placeholder="?">
            </div>
            <div style="display:flex; gap:10px;">
                <label style="color:#f1c40f"><input type="checkbox" id="admin-infinite-rolls"> ç„¡é™æ“²éª°</label>
            </div>
        </div>

        <div class="score-board">
            <div class="column">
                <table><tbody id="upper-section"></tbody></table>
            </div>
            <div class="column">
                <table><tbody id="lower-section"></tbody></table>
            </div>
        </div>

        <div id="grand-total-display">ç¸½åˆ†: <span id="grand-total">0</span></div>
    </div>

    <div id="challenge-name-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>è¼¸å…¥æŒ‘æˆ°æš±ç¨±</h3>
            <input type="text" id="challenge-nickname-input" placeholder="åç¨±" maxlength="8" style="width:90%; color:black;">
            <div style="margin-top:10px; display:flex; gap:5px; justify-content:center;">
                <button class="action-btn join-btn" onclick="confirmChallengeStart()">é–‹å§‹</button>
                <button class="action-btn delete-btn" onclick="document.getElementById('challenge-name-modal').style.display='none'">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7PZLTTNf17cfp9gCHudWiWX8SYPSCdDI",
            authDomain: "onlineeasyraygame.firebaseapp.com",
            databaseURL: "https://onlineeasyraygame-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "onlineeasyraygame",
            storageBucket: "onlineeasyraygame.firebasestorage.app",
            messagingSenderId: "622138442346",
            appId: "1:622138442346:web:9e29ef572d334f83428013",
            measurementId: "G-ZT703DH0ZS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const ROOMS_ROOT = "yahtzee_rooms";
        const CHALLENGE_ROOT = "challenge_rooms";

        // Global State
        let myNickname = "";
        let myPlayerId = "";
        let currentRoomId = "";
        let currentRoomData = null;
        let isMyTurn = false;
        
        // Game Modes: 'multiplayer', 'solo', 'challenge', 'view_record'
        let currentGameMode = 'solo'; 
        
        // Admin State
        let isAdmin = false;
        let isWangTester = false;
        let keyBuffer = "";
        const SECRET_CODE = "991020";

        // Challenge Specifics
        let currentChallengeRoomId = null;
        let currentChallengeLeaderboard = []; // Cache for duplicate checking

        // Solo / Local Game State (Used for Solo & Challenge)
        let soloState = {
            dice: [1, 1, 1, 1, 1],
            locked: [false, false, false, false, false],
            rollsLeft: 3,
            isRolling: false,
            board: {},
            score: 0
        };
        let localSelection = null; 

        // --- 1. Event Listeners & Init ---

        window.addEventListener('keydown', (e) => {
            if(document.getElementById('landing-view').classList.contains('active-view')) {
                if(e.key >= "0" && e.key <= "9") {
                    keyBuffer += e.key;
                    if(keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);
                    if(keyBuffer.endsWith(SECRET_CODE)) {
                        enableAdminMode();
                        keyBuffer = ""; 
                    }
                }
            }
        });

        function enableAdminMode() {
            if(isAdmin) return;
            isAdmin = true;
            document.getElementById('admin-entry-btn').classList.add('visible');
            document.querySelectorAll('.admin-controls-area').forEach(e => e.classList.add('active'));
            // FIX: If we are already in the game view, show the panel immediately
            if(document.getElementById('game-view').classList.contains('active-view')) {
                document.getElementById('admin-panel').classList.add('active');
            }
            alert("God Mode Enabled");
        }

        window.showView = (id) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active-view');
        };

        window.showTutorial = () => showView('tutorial-view');

        // --- 2. Multiplayer Logic (Existing/Adapted) ---

        window.goToNickname = () => {
            currentGameMode = 'multiplayer';
            if (isWangTester) {
                myNickname = "æ±ª(æ¸¬è©¦å“¡)";
                myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
                document.getElementById('lobby-nickname').innerText = myNickname;
                showView('lobby-view');
                listenToMultiplayerRooms();
            } else {
                showView('nickname-view');
            }
        };

        window.enterLobby = () => {
            const input = document.getElementById('nickname-input');
            const val = input.value.trim();
            if(!val) { alert("è«‹è¼¸å…¥æš±ç¨±"); return; }
            
            if (val === "991025") {
                isWangTester = true;
                enableAdminMode();
                alert("æ­¡è¿æ±ªæ¸¬è©¦å“¡");
                showView('landing-view'); 
                input.value = ""; 
                return;
            }

            myNickname = val;
            myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
            document.getElementById('lobby-nickname').innerText = myNickname;
            showView('lobby-view');
            listenToMultiplayerRooms();
        };

        window.createRoom = async () => {
            const playerCount = parseInt(document.getElementById('player-count-select').value);
            const newRoomRef = push(ref(db, ROOMS_ROOT));
            const roomId = newRoomRef.key;
            
            await set(newRoomRef, {
                id: roomId,
                host: myNickname,
                status: "waiting",
                maxPlayers: playerCount,
                currentTurnIndex: 0,
                gameState: { dice: [1,1,1,1,1], locked: [false,false,false,false,false], rollsLeft: 3, isRolling: false },
                players: {
                    [myPlayerId]: { nickname: myNickname, score: 0, board: {} }
                }
            });
            joinMultiplayerRoom(roomId);
        };

        function listenToMultiplayerRooms() {
            onValue(ref(db, ROOMS_ROOT), (snapshot) => {
                if(!document.getElementById('lobby-view').classList.contains('active-view')) return;
                const list = document.getElementById('room-list-container');
                list.innerHTML = "";
                const data = snapshot.val();
                if(!data) { list.innerHTML = "<div style='color:#666'>ç„¡æˆ¿é–“</div>"; return; }

                Object.values(data).forEach(room => {
                    if(room.status === 'waiting') {
                        const count = room.players ? Object.keys(room.players).length : 0;
                        const div = document.createElement('div');
                        div.className = 'room-item';
                        div.innerHTML = `
                            <div><span style="font-weight:bold">${room.host}</span> <span class="room-status">${count}/${room.maxPlayers}</span></div>
                            <button class="action-btn join-btn" onclick="window.tryJoin('${room.id}')">åŠ å…¥</button>
                        `;
                        list.appendChild(div);
                    }
                });
            });
        }

        window.tryJoin = async (roomId) => {
            const roomRef = ref(db, `${ROOMS_ROOT}/${roomId}`);
            const snapshot = await get(roomRef);
            if(!snapshot.exists()) { alert("æˆ¿é–“ä¸å­˜åœ¨"); return; }
            const room = snapshot.val();
            if(room.status !== 'waiting') { alert("éŠæˆ²å·²é–‹å§‹"); return; }
            if(Object.keys(room.players || {}).length >= room.maxPlayers) { alert("æˆ¿é–“å·²æ»¿"); return; }

            // Bug fix: Removed manual index assignment to avoid race conditions
            await update(ref(db, `${ROOMS_ROOT}/${roomId}/players/${myPlayerId}`), {
                nickname: myNickname, score: 0, board: {}
            });
            joinMultiplayerRoom(roomId);
        };

        function joinMultiplayerRoom(roomId) {
            currentRoomId = roomId;
            const roomRef = ref(db, `${ROOMS_ROOT}/${roomId}`);
            onDisconnect(ref(db, `${ROOMS_ROOT}/${roomId}/players/${myPlayerId}`)).remove();

            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) { 
                    if(currentGameMode === 'multiplayer') { alert("æˆ¿é–“å·²è§£æ•£"); showView('lobby-view'); }
                    return; 
                }
                currentRoomData = data;
                
                // Event Handling (Yahtzee)
                if (data.lastEvent && data.lastEvent.id > (window.lastProcessedEventId || 0)) {
                    window.lastProcessedEventId = data.lastEvent.id;
                    if (data.lastEvent.type === 'YAHTZEE') showOverlay(`YAHTZEE!`, `${data.lastEvent.nickname} éª°å‡º Yahtzee!`, true, 4000);
                }

                // BUG FIX: Sort players by Key ID (timestamp based) to ensure consistent order across clients
                const players = Object.entries(data.players || {})
                    .map(([key, val]) => ({...val, pid: key}))
                    .sort((a,b) => a.pid.localeCompare(b.pid));
                
                if (data.status === 'waiting') {
                    showView('waiting-view');
                    document.getElementById('wait-room-id').innerText = roomId.slice(-4);
                    document.getElementById('wait-player-count').innerText = players.length;
                    document.getElementById('wait-max-players').innerText = data.maxPlayers;
                    document.getElementById('wait-player-list').innerHTML = players.map(p => `<div class="room-item">${p.nickname} ${p.nickname===myNickname?'(ä½ )':''}</div>`).join('');
                    
                    if(myNickname === data.host) {
                        document.getElementById('host-start-btn').style.display = 'block';
                        if(players.length >= data.maxPlayers) update(roomRef, { status: 'playing' });
                    }
                } else if (data.status === 'playing') {
                    if(!document.getElementById('game-view').classList.contains('active-view')) {
                        initGameUI('multiplayer');
                        showView('game-view');
                        // FIX: Ensure admin panel shows if user is already admin
                        if(isAdmin) document.getElementById('admin-panel').classList.add('active');
                    }
                    syncMultiplayerUI(data, players);
                    checkGameOver(players);
                }
            });
        }

        window.leaveWaitingRoom = async () => {
            if(currentRoomId) await remove(ref(db, `${ROOMS_ROOT}/${currentRoomId}/players/${myPlayerId}`));
            currentRoomId = ""; showView('lobby-view');
        };

        window.manualStartGame = async () => {
            if(currentRoomId) update(ref(db, `${ROOMS_ROOT}/${currentRoomId}`), { status: 'playing' });
        };

        // --- 3. Challenge Arena Logic (New) ---

        window.showChallengeLobby = () => {
            showView('challenge-lobby-view');
            // Listen for rooms
            onValue(ref(db, CHALLENGE_ROOT), (snapshot) => {
                const list = document.getElementById('challenge-room-list');
                list.innerHTML = "";
                const data = snapshot.val();
                if(!data) { list.innerHTML = "<div style='padding:10px;'>ç›®å‰æ²’æœ‰æ“‚å°ã€‚</div>"; return; }

                Object.keys(data).forEach(key => {
                    const room = data[key];
                    const isProtected = room.password && room.password.trim() !== "";
                    
                    const div = document.createElement('div');
                    div.className = 'room-item';
                    div.innerHTML = `
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:var(--accent-color)">${room.name}</div>
                            <div class="room-status">${isProtected ? 'ğŸ”’ ç§äºº' : 'ğŸ”“ å…¬é–‹'} | æ¦œå–®: ${room.leaderboard ? Object.keys(room.leaderboard).length : 0}äºº</div>
                        </div>
                        <div>
                            <button class="action-btn view-btn" onclick="window.enterChallengeRoom('${key}', '${room.password||''}', '${room.name}')">é€²å…¥</button>
                            ${(isAdmin || isWangTester) ? `<button class="action-btn delete-btn" onclick="window.deleteChallengeRoom('${key}')">åˆªé™¤</button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        };

        window.createChallengeRoom = async () => {
            const name = document.getElementById('new-challenge-name').value.trim();
            const pass = document.getElementById('new-challenge-pass').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥åç¨±"); return; }
            
            const newRef = push(ref(db, CHALLENGE_ROOT));
            await set(newRef, {
                name: name,
                password: pass,
                createdAt: Date.now()
            });
            document.getElementById('new-challenge-name').value = "";
            document.getElementById('new-challenge-pass').value = "";
        };

        window.deleteChallengeRoom = async (roomId) => {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ“‚å°ï¼Ÿ")) await remove(ref(db, `${CHALLENGE_ROOT}/${roomId}`));
        };

        window.enterChallengeRoom = async (roomId, password, roomName) => {
            if (password && password !== "" && !isAdmin && !isWangTester) {
                const input = prompt("è«‹è¼¸å…¥æ“‚å°å¯†ç¢¼:");
                if(input !== password) { alert("å¯†ç¢¼éŒ¯èª¤"); return; }
            }

            currentChallengeRoomId = roomId;
            document.getElementById('c-room-title').innerText = roomName;
            document.getElementById('c-room-id').innerText = roomId;
            showView('challenge-room-detail');

            // Listen to leaderboard
            onValue(ref(db, `${CHALLENGE_ROOT}/${roomId}/leaderboard`), (snapshot) => {
                const list = document.getElementById('c-leaderboard-list');
                list.innerHTML = "";
                const data = snapshot.val();
                currentChallengeLeaderboard = []; // Reset cache

                if(!data) { list.innerHTML = "<div style='padding:10px; color:#aaa'>æš«ç„¡æŒ‘æˆ°ç´€éŒ„</div>"; return; }

                // Convert to array and sort by score desc
                const entries = Object.entries(data).map(([k, v]) => ({key: k, ...v}));
                entries.sort((a,b) => b.score - a.score);
                currentChallengeLeaderboard = entries; // Save for duplicate check

                entries.forEach((entry, idx) => {
                    const div = document.createElement('div');
                    div.className = 'room-item leaderboard-item';
                    
                    let rankColor = "#aaa";
                    if(idx===0) rankColor = "#f1c40f"; // Gold
                    else if(idx===1) rankColor = "#bdc3c7"; // Silver
                    else if(idx===2) rankColor = "#cd7f32"; // Bronze

                    div.innerHTML = `
                        <div style="color:${rankColor}; overflow:hidden; text-overflow:ellipsis;">
                            <span style="font-weight:bold;">#${idx+1}</span> ${entry.nickname}
                        </div>
                        <div style="text-align:center; font-family:monospace; font-weight:bold;">${entry.score}</div>
                        <div style="display:flex; justify-content:flex-end; gap:5px;">
                            <button class="action-btn view-btn" onclick="window.viewPlayerRecord('${entry.key}')">æŸ¥çœ‹</button>
                            ${(isAdmin || isWangTester) ? `<button class="action-btn delete-btn" style="padding:2px 5px;" onclick="window.deleteChallengeEntry('${entry.key}')">X</button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        };

        window.deleteChallengeEntry = async (entryKey) => {
            if(confirm("ç§»é™¤æ­¤ç´€éŒ„ï¼Ÿ")) await remove(ref(db, `${CHALLENGE_ROOT}/${currentChallengeRoomId}/leaderboard/${entryKey}`));
        };

        window.viewPlayerRecord = (entryKey) => {
            const entry = currentChallengeLeaderboard.find(e => e.key === entryKey);
            if(!entry) return;

            currentGameMode = 'view_record';
            initGameUI('record');
            showView('game-view');
            
            // UI Tweaks for record view
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('record-controls').style.display = 'flex';
            document.getElementById('turn-indicator').innerText = `æŸ¥çœ‹: ${entry.nickname} çš„ç´€éŒ„`;
            document.getElementById('turn-indicator').style.background = "#3498db";
            
            // Render board
            const dummyPlayer = { nickname: entry.nickname, score: entry.score, board: entry.board, isMe: true };
            renderScoreTables([dummyPlayer]);
            document.getElementById('grand-total').innerText = entry.score;
        };

        window.exitRecordView = () => {
            showView('challenge-room-detail');
        };

        window.promptChallengeStart = () => {
            if(isWangTester) {
                startChallengeRun("æ±ª(æ¸¬è©¦å“¡)");
            } else {
                document.getElementById('challenge-name-modal').style.display = 'flex';
                document.getElementById('challenge-nickname-input').focus();
            }
        };

        window.confirmChallengeStart = () => {
            const name = document.getElementById('challenge-nickname-input').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥åç¨±"); return; }

            // Check duplicate
            const exists = currentChallengeLeaderboard.some(e => e.nickname === name);
            if(exists) {
                alert("æ­¤æš±ç¨±å·²åœ¨æ¦œå–®ä¸Šï¼Œè«‹ä½¿ç”¨å…¶ä»–åç¨±ï¼");
                return;
            }

            document.getElementById('challenge-name-modal').style.display = 'none';
            startChallengeRun(name);
        };

        function startChallengeRun(nickname) {
            myNickname = nickname;
            currentGameMode = 'challenge';
            
            // Reset Solo State
            soloState = {
                dice: [1, 1, 1, 1, 1],
                locked: [false, false, false, false, false],
                rollsLeft: 3,
                isRolling: false,
                board: {},
                score: 0
            };
            localSelection = null;

            initGameUI('challenge');
            showView('game-view');
            
            document.getElementById('turn-indicator').innerText = "æŒ‘æˆ°é–‹å§‹ï¼";
            document.getElementById('turn-indicator').style.background = "#e74c3c";
            document.getElementById('ingame-players-bar').innerHTML = `<div class="player-badge active-turn is-me">${myNickname}</div>`;
            document.getElementById('rolls-left').innerText = "3";
            document.getElementById('roll-btn').disabled = false;
            document.getElementById('confirm-btn').disabled = true;
            
            if(isAdmin) document.getElementById('admin-panel').classList.add('active');
            
            updateDiceVisuals(soloState.dice, false, soloState.locked);
            renderScoreTables([{ nickname: myNickname, score: 0, board: {}, isMe: true }]);
        }


        // --- 4. Solo / Challenge Game Logic ---

        window.startSoloGame = () => {
            currentGameMode = 'solo';
            myNickname = "ç·´ç¿’è€…";
            
            soloState = {
                dice: [1, 1, 1, 1, 1],
                locked: [false, false, false, false, false],
                rollsLeft: 3,
                isRolling: false,
                board: {},
                score: 0
            };
            localSelection = null;

            initGameUI('solo');
            showView('game-view');
            if(isAdmin) document.getElementById('admin-panel').classList.add('active');
            
            document.getElementById('turn-indicator').innerText = "å–®æ©Ÿç·´ç¿’æ¨¡å¼";
            document.getElementById('turn-indicator').style.background = "#27ae60";
            document.getElementById('ingame-players-bar').innerHTML = `<div class="player-badge active-turn is-me">${myNickname}</div>`;
            
            updateDiceVisuals(soloState.dice, false, soloState.locked);
            renderScoreTables([{ nickname: myNickname, score: 0, board: {}, isMe: true }]);
        };

        window.quitGame = async () => {
            if(!confirm("ç¢ºå®šè¦é€€å‡ºéŠæˆ²å—ï¼Ÿ")) return;
            
            if(currentGameMode === 'multiplayer' && currentRoomId) {
                await remove(ref(db, `${ROOMS_ROOT}/${currentRoomId}/players/${myPlayerId}`));
                location.reload();
            } else if (currentGameMode === 'challenge') {
                showView('challenge-room-detail'); // Go back to leaderboard without saving
            } else {
                location.reload(); // Solo
            }
        };

        // --- 5. Shared Game Core ---

        function initGameUI(mode) {
            document.getElementById('game-controls').style.display = 'flex';
            document.getElementById('record-controls').style.display = 'none';
            const container = document.getElementById('dice-container');
            container.innerHTML = '';
            for(let i=0; i<5; i++) {
                container.innerHTML += `
                <div class="cube-wrapper" onclick="window.toggleLock(${i})">
                    <div class="cube" id="die-${i}">
                        <div class="face front face-1"><div class="dot"></div></div>
                        <div class="face back face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face right face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face left face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face top face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face bottom face-2"><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>`;
            }
        }

        function syncMultiplayerUI(data, playerList) {
            const gameState = data.gameState;
            const safeIndex = data.currentTurnIndex % playerList.length;
            const currentPlayer = playerList[safeIndex];
            if(!currentPlayer) return;

            isMyTurn = (currentPlayer.nickname === myNickname);
            
            document.getElementById('turn-indicator').innerText = isMyTurn ? "è¼ªåˆ°ä½ äº†ï¼" : `ç­‰å¾… ${currentPlayer.nickname}...`;
            document.getElementById('turn-indicator').style.background = isMyTurn ? '#27ae60' : '#2980b9';
            
            document.getElementById('ingame-players-bar').innerHTML = playerList.map(p => 
                `<div class="player-badge ${p.nickname===currentPlayer.nickname?'active-turn':''} ${p.nickname===myNickname?'is-me':''}">
                    ${p.nickname}: ${p.score}
                </div>`
            ).join('');

            updateDiceVisuals(gameState.dice, gameState.isRolling, gameState.locked);
            document.getElementById('rolls-left').innerText = gameState.rollsLeft;
            
            const rollBtn = document.getElementById('roll-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;

            if(isMyTurn) {
                rollBtn.disabled = (!isInfinite && gameState.rollsLeft <= 0) || gameState.isRolling;
                if(!localSelection) confirmBtn.disabled = true;
            } else {
                rollBtn.disabled = true;
                confirmBtn.disabled = true;
                localSelection = null;
            }

            renderScoreTables(playerList.map(p => ({...p, isMe: p.nickname===myNickname})));
        }

        window.handleRollClick = () => {
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            
            // Get override values if admin
            const getRollValue = (idx) => {
                if(isAdmin) {
                    const v = parseInt(document.getElementById(`admin-d${idx}`).value);
                    if(v>=1 && v<=6) return v;
                }
                return Math.floor(Math.random()*6)+1;
            };

            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                if(!isInfinite && soloState.rollsLeft <= 0) return;
                if(soloState.isRolling) return;
                
                soloState.isRolling = true;
                updateDiceVisuals(soloState.dice, true, soloState.locked);
                
                setTimeout(() => {
                    const newDice = [...soloState.dice];
                    for(let i=0; i<5; i++) if(!soloState.locked[i]) newDice[i] = getRollValue(i);
                    soloState.dice = newDice;
                    if(!isInfinite) soloState.rollsLeft--;
                    soloState.isRolling = false;
                    
                    updateDiceVisuals(soloState.dice, false, soloState.locked);
                    document.getElementById('rolls-left').innerText = soloState.rollsLeft;
                    document.getElementById('roll-btn').disabled = (!isInfinite && soloState.rollsLeft <= 0);
                    localSelection = null; document.getElementById('confirm-btn').disabled = true;
                }, 600);
            } 
            else if(currentGameMode === 'multiplayer' && isMyTurn) {
                const state = currentRoomData.gameState;
                if(!isInfinite && state.rollsLeft <= 0) return;
                if(state.isRolling) return;
                
                update(ref(db, `${ROOMS_ROOT}/${currentRoomId}/gameState`), { isRolling: true });
                const newDice = [...state.dice];
                for(let i=0; i<5; i++) if(!state.locked[i]) newDice[i] = getRollValue(i);
                
                setTimeout(() => {
                    update(ref(db, `${ROOMS_ROOT}/${currentRoomId}/gameState`), {
                        dice: newDice, rollsLeft: isInfinite? state.rollsLeft : state.rollsLeft-1, isRolling: false
                    });
                }, 800);
            }
        };

        window.toggleLock = (index) => {
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            if(currentGameMode === 'view_record') return;

            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                if(!isInfinite && soloState.rollsLeft === 3) return; 
                if(soloState.isRolling) return;
                soloState.locked[index] = !soloState.locked[index];
                updateDiceVisuals(soloState.dice, false, soloState.locked);
            } else if (currentGameMode === 'multiplayer' && isMyTurn) {
                 const state = currentRoomData.gameState;
                 if(!isInfinite && state.rollsLeft === 3) return;
                 if(state.isRolling) return;
                 const newLocked = [...state.locked];
                 newLocked[index] = !newLocked[index];
                 update(ref(db, `${ROOMS_ROOT}/${currentRoomId}/gameState`), { locked: newLocked });
            }
        };

        window.handleScoreSelect = (type, key) => {
            if(currentGameMode === 'view_record') return;
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            
            let state, board;
            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                state = soloState; board = soloState.board;
            } else {
                if(!isMyTurn) return;
                state = currentRoomData.gameState;
                board = currentRoomData.players[myPlayerId].board || {};
            }

            if(!isInfinite && state.rollsLeft === 3 && state.dice[0] === 1 && !localSelection) return;
            if(state.isRolling) return;

            let cellId = (type==='upper') ? `s${key}` : `s-${key}`;
            if(board[cellId] !== undefined) return;

            let score = calculateScore(type, key, state.dice);
            
            // Clear prev
            if(localSelection && document.getElementById(localSelection.cellId)) {
                document.getElementById(localSelection.cellId).innerText = '-';
                document.getElementById(localSelection.cellId).classList.remove('preview-text');
                document.getElementById(localSelection.cellId).closest('tr').classList.remove('selected-row');
            }

            localSelection = { type, key, score, cellId };
            const cell = document.getElementById(cellId);
            cell.innerText = score;
            cell.classList.add('preview-text');
            cell.closest('tr').classList.add('selected-row');
            document.getElementById('confirm-btn').disabled = false;
        };

        window.handleConfirmClick = async () => {
            if(!localSelection) return;
            const { cellId, score, key } = localSelection;
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            
            let dice, currentYahtzeeScore = 0;
            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                dice = soloState.dice;
                currentYahtzeeScore = soloState.board['s-yahtzee'] || 0;
            } else {
                dice = currentRoomData.gameState.dice;
                // Safe check for board existance
                const pBoard = currentRoomData.players[myPlayerId].board || {};
                currentYahtzeeScore = pBoard['s-yahtzee'] || 0;
            }

            // Yahtzee Logic
            const isYahtzeeRoll = dice.every(d => d === dice[0]);
            let bonusToAdd = (isYahtzeeRoll && currentYahtzeeScore >= 50) ? 100 : 0;
            let isPrimaryYahtzee = (key === 'yahtzee' && score === 50);

            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                if(isPrimaryYahtzee) showOverlay("YAHTZEE!", "æ¼‚äº®ï¼", true, 3000);
                if(bonusToAdd > 0) {
                    showOverlay("BONUS YAHTZEE!", "+100 åˆ†ï¼", true, 3000);
                    soloState.board['s-yahtzee'] = currentYahtzeeScore + bonusToAdd;
                }
                
                soloState.board[cellId] = score;
                soloState.score = calculateRealScore(soloState.board);
                
                // Reset Round
                soloState.dice = [1,1,1,1,1];
                soloState.locked = [false,false,false,false,false];
                soloState.rollsLeft = 3;
                
                // UI Update
                renderScoreTables([{ nickname: myNickname, score: soloState.score, board: soloState.board, isMe: true }]);
                updateDiceVisuals(soloState.dice, false, soloState.locked);
                document.getElementById('rolls-left').innerText = "3";
                document.getElementById('roll-btn').disabled = false;
                localSelection = null;
                document.getElementById('confirm-btn').disabled = true;
                
                if(isAdmin) document.querySelectorAll('.admin-die-input').forEach(el => el.value = "");
                
                checkGameOver([{ board: soloState.board, nickname: myNickname }]);
            } 
            else if(currentGameMode === 'multiplayer') {
                // ... Multiplayer update logic (Same as before) ...
                const roomId = currentRoomId;
                const updates = {};
                updates[`${ROOMS_ROOT}/${roomId}/players/${myPlayerId}/board/${cellId}`] = score;
                if(bonusToAdd > 0) updates[`${ROOMS_ROOT}/${roomId}/players/${myPlayerId}/board/s-yahtzee`] = currentYahtzeeScore + bonusToAdd;
                
                // Calc Score
                const newBoard = { ...(currentRoomData.players[myPlayerId].board || {}), [cellId]: score };
                if(bonusToAdd > 0) newBoard['s-yahtzee'] = currentYahtzeeScore + bonusToAdd;
                const newTotal = calculateRealScore(newBoard);
                updates[`${ROOMS_ROOT}/${roomId}/players/${myPlayerId}/score`] = newTotal;

                if(isPrimaryYahtzee || bonusToAdd > 0) {
                     updates[`${ROOMS_ROOT}/${roomId}/lastEvent`] = { type: 'YAHTZEE', nickname: myNickname + (bonusToAdd?" (+100)":""), id: Date.now() };
                }

                // Turn pass
                // BUG FIX: Ensure we count players correctly from keys for next turn
                const pIds = Object.keys(currentRoomData.players).sort(); // Basic string sort matches timestamp keys
                const nextTurn = (currentRoomData.currentTurnIndex + 1) % pIds.length;
                
                updates[`${ROOMS_ROOT}/${roomId}/currentTurnIndex`] = nextTurn;
                updates[`${ROOMS_ROOT}/${roomId}/gameState`] = { dice: [1,1,1,1,1], locked: [false,false,false,false,false], rollsLeft: 3, isRolling: false };
                
                await update(ref(db), updates);
                localSelection = null; document.getElementById('confirm-btn').disabled = true;
                if(isAdmin) document.querySelectorAll('.admin-die-input').forEach(el => el.value = "");
            }
        };

        // --- 6. Helper Functions ---

        function updateDiceVisuals(values, isRolling, lockedStatus) {
            for(let i=0; i<5; i++) {
                const dieElem = document.getElementById(`die-${i}`);
                const wrapper = document.querySelectorAll('.cube-wrapper')[i];
                if(lockedStatus[i]) wrapper.classList.add('locked'); else wrapper.classList.remove('locked');
                
                if(isRolling && !lockedStatus[i]) {
                    dieElem.style.transform = `rotateX(${Math.random()*720}deg) rotateY(${Math.random()*720}deg)`;
                } else {
                    let x=0, y=0;
                    switch(values[i]) {
                        case 1: x=0; y=0; break; case 2: x=90; y=0; break; case 3: x=0; y=-90; break;
                        case 4: x=0; y=90; break; case 5: x=-90; y=0; break; case 6: x=0; y=180; break;
                    }
                    dieElem.style.transform = `rotateX(${x}deg) rotateY(${y}deg)`;
                }
            }
        }

        function calculateRealScore(board) {
            if(!board) return 0;
            let uSum=0; for(let k=1; k<=6; k++) if(board[`s${k}`]) uSum+=board[`s${k}`];
            let bonus = uSum>=63 ? 35 : 0;
            let lSum=0;
            ['s-3ok','s-4ok','s-full','s-sm-str','s-lg-str','s-yahtzee','s-chance'].forEach(k => { if(board[k]) lSum+=board[k]; });
            return uSum + bonus + lSum;
        }

        function renderScoreTables(players) {
            const upper = document.getElementById('upper-section');
            const lower = document.getElementById('lower-section');
            let header = `<tr><th class="icon-col"></th>` + players.map(p=>`<th class="player-header ${p.isMe?'is-me-header':''}">${p.nickname}</th>`).join('') + `</tr>`;
            
            // Upper
            let uHTML = header;
            for(let i=1; i<=6; i++) {
                uHTML += `<tr class="score-row" onclick="window.handleScoreSelect('upper', ${i})">
                    <td class="icon-col"><div class="mini-die m-d-${i}">${Array(i).fill('<div class="mini-dot"></div>').join('')}</div></td>
                    ${players.map(p => {
                        // FIX: Safely handle if p.board is undefined (Firebase removes empty objects)
                        const b = p.board || {}; 
                        const val = (b[`s${i}`] !== undefined) ? b[`s${i}`] : '-';
                        return `<td ${p.isMe?`id="s${i}"`:''} class="score-cell ${p.isMe?'my-cell':''} ${val!=='-'?'filled':''}">${val}</td>`;
                    }).join('')}
                </tr>`;
            }
            // Bonus Row (CRITICAL FIX WAS HERE)
            uHTML += `<tr style="background:#333;height:25px;"><td class="icon-col" style="color:#bbb;font-size:0.7rem">ç</td>
                ${players.map(p => {
                    let s=0; 
                    const b = p.board || {}; // CRITICAL FIX: Default to empty object if board is missing
                    for(let k=1;k<=6;k++) if(b[`s${k}`]) s+=b[`s${k}`];
                    return `<td class="score-cell" style="color:${s>=63?'#2ecc71':'#888'};font-size:0.7rem;">${s>=63?'35':`${s}/63`}</td>`;
                }).join('')}
            </tr>`;
            upper.innerHTML = uHTML;

            // Lower
            let lHTML = header;
            const cats = [{k:'3ok',n:'3X'},{k:'4ok',n:'4X'},{k:'full',n:'ğŸ '},{k:'sm-str',n:'å°é †'},{k:'lg-str',n:'å¤§é †'},{k:'yahtzee',n:'Y!'},{k:'chance',n:'?'}];
            cats.forEach(c => {
                lHTML += `<tr class="score-row" onclick="window.handleScoreSelect('lower', '${c.k}')">
                    <td class="symbol-text icon-col">${c.n}</td>
                    ${players.map(p => {
                        const b = p.board || {};
                        const val = (b[`s-${c.k}`] !== undefined) ? b[`s-${c.k}`] : '-';
                        return `<td ${p.isMe?`id="s-${c.k}"`:''} class="score-cell ${p.isMe?'my-cell':''} ${val!=='-'?'filled':''}">${val}</td>`;
                    }).join('')}
                </tr>`;
            });
            lower.innerHTML = lHTML;

            // Update Total
            const me = players.find(p => p.isMe);
            if(me) document.getElementById('grand-total').innerText = calculateRealScore(me.board || {});
            
            // Restore Preview
            if(localSelection) {
                const c = document.getElementById(localSelection.cellId);
                if(c) { c.innerText=localSelection.score; c.classList.add('preview-text'); c.closest('tr').classList.add('selected-row'); }
            }
        }

        function checkGameOver(players) {
            const me = players.find(p => p.nickname === myNickname); 
            // Check if I finished (13 entries)
            // Fix: Check if board exists
            if(me && me.board && Object.keys(me.board).length >= 13) {
                const finalScore = calculateRealScore(me.board);
                
                if(currentGameMode === 'challenge') {
                    // Upload Score
                    showOverlay("æŒ‘æˆ°çµæŸ", `å¾—åˆ†: ${finalScore}`, true, 0);
                    
                    // Push to Leaderboard
                    push(ref(db, `${CHALLENGE_ROOT}/${currentChallengeRoomId}/leaderboard`), {
                        nickname: myNickname,
                        score: finalScore,
                        board: me.board,
                        timestamp: Date.now()
                    });
                    
                    // Change Overlay button behavior
                    setTimeout(() => {
                        const exitBtn = document.getElementById('overlay-exit-btn');
                        if(exitBtn) {
                            exitBtn.innerText = "å›åˆ°æ¦œå–®";
                            exitBtn.onclick = () => {
                                document.getElementById('special-event-overlay').classList.remove('active');
                                showView('challenge-room-detail');
                            };
                        }
                    }, 100);

                } else if (currentGameMode === 'solo') {
                    showOverlay("éŠæˆ²çµæŸ", `å¾—åˆ†: ${finalScore}`, true, 0);
                } else {
                    // Multiplayer: Check everyone
                    // Fix: Check if board exists for everyone
                    if(players.every(p => p.board && Object.keys(p.board).length >= 13)) {
                        let winner = players[0]; let max = -1;
                        players.forEach(p => { 
                            let s = calculateRealScore(p.board || {}); 
                            if(s>max){max=s; winner=p;} 
                        });
                        showOverlay("æ­å–œç²å‹ï¼", `${winner.nickname} ä»¥ ${max} åˆ†ç²å‹ï¼`, true, 0);
                    }
                }
            }
        }

        function showOverlay(title, sub, rainbow, duration) {
            const ov = document.getElementById('special-event-overlay');
            document.getElementById('overlay-title').innerText = title;
            document.getElementById('overlay-sub').innerText = sub;
            if(rainbow) ov.classList.add('rainbow-bg'); else ov.classList.remove('rainbow-bg');
            ov.classList.add('active');
            
            // Cleanup old
            document.querySelectorAll('.confetti').forEach(e=>e.remove());
            const oldBtn = document.getElementById('overlay-exit-btn'); if(oldBtn) oldBtn.remove();

            // Confetti
            for(let i=0;i<50;i++){
                const c = document.createElement('div'); c.className='confetti';
                c.style.left=Math.random()*100+'%'; c.style.backgroundColor=`hsl(${Math.random()*360},100%,50%)`;
                c.style.animationDuration=(2+Math.random()*2)+'s';
                ov.appendChild(c);
            }

            if(duration === 0) {
                const btn = document.createElement('button');
                btn.id = 'overlay-exit-btn';
                btn.className = 'menu-btn primary';
                btn.style.marginTop = '30px'; btn.style.pointerEvents='auto';
                btn.innerText = 'å›åˆ°é¦–é ';
                btn.onclick = () => location.reload();
                ov.appendChild(btn);
            } else {
                setTimeout(() => { ov.classList.remove('active'); }, duration);
            }
        }
        
        function calculateScore(type, key, dice) {
            if (type === 'upper') return dice.filter(d => d === key).length * key;
            const counts = {}; dice.forEach(x => counts[x] = (counts[x]||0)+1);
            const vals = Object.values(counts);
            const sum = dice.reduce((a,b)=>a+b,0);
            const uniq = [...new Set(dice)].sort((a,b)=>a-b);
            const isSeq = (n) => {
                let max=1, cur=1; 
                for(let i=0;i<uniq.length-1;i++) { if(uniq[i+1]===uniq[i]+1) cur++; else cur=1; if(cur>max) max=cur; }
                return max >= n;
            };

            switch(key) {
                case '3ok': return vals.some(c=>c>=3) ? sum : 0;
                case '4ok': return vals.some(c=>c>=4) ? sum : 0;
                case 'full': return (vals.includes(3)&&vals.includes(2)) || vals.includes(5) ? 25 : 0;
                case 'sm-str': return isSeq(4) ? 30 : 0;
                case 'lg-str': return isSeq(5) ? 40 : 0;
                case 'yahtzee': return vals.includes(5) ? 50 : 0;
                case 'chance': return sum;
                default: return 0;
            }
        }

        // --- Enhanced Admin Logic ---

        window.adminDeleteRoom = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤æˆ¿é–“ï¼Ÿ")) remove(ref(db,`${ROOMS_ROOT}/${id}`)); };
        
        window.adminForceStart = async (id) => {
             if(confirm("å¼·åˆ¶é–‹å§‹éŠæˆ²ï¼Ÿ")) update(ref(db, `${ROOMS_ROOT}/${id}`), { status: 'playing' });
        };
        
        window.adminResetTurn = async (id) => {
             // Emergency fix if turn gets stuck
             if(confirm("é‡ç½®å›åˆéª°å­ï¼Ÿ")) update(ref(db, `${ROOMS_ROOT}/${id}/gameState`), { rollsLeft: 3, isRolling: false, locked: [false,false,false,false,false] });
        };

        window.showAdminRoomManager = () => {
             showView('admin-room-view');
             onValue(ref(db, ROOMS_ROOT), snap => {
                 const list = document.getElementById('admin-room-list'); list.innerHTML='';
                 const d = snap.val(); 
                 if(!d) { list.innerHTML = "<div style='color:#777'>ç›®å‰æ²’æœ‰æ´»èºæˆ¿é–“</div>"; return; }
                 
                 // Sort by newest first
                 const rooms = Object.values(d).reverse();
                 
                 rooms.forEach(r => {
                     const players = r.players ? Object.values(r.players) : [];
                     const pCount = players.length;
                     const pNames = players.map(p => `${p.nickname}(${p.score||0})`).join(', ');
                     const lastEvt = r.lastEvent ? `Event: ${r.lastEvent.type} by ${r.lastEvent.nickname}` : '';

                     list.innerHTML += `
                     <div class="admin-room-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; color:var(--accent-color);">${r.host} çš„æˆ¿é–“</span>
                            <span style="font-size:0.8rem; background:${r.status==='playing'?'#27ae60':'#f39c12'}; padding:2px 6px; border-radius:4px;">${r.status}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#ccc; line-height:1.4;">
                            ID: <span style="font-family:monospace">${r.id}</span><br>
                            ç©å®¶ (${pCount}/${r.maxPlayers}): ${pNames}<br>
                            å›åˆ: ${r.currentTurnIndex || 0} | å‰©é¤˜æ“²éª°: ${r.gameState?.rollsLeft}<br>
                            ${lastEvt ? `<span style="color:#f1c40f">${lastEvt}</span>` : ''}
                        </div>
                        <div style="margin-top:8px; display:flex; justify-content:flex-end;">
                            <button class="action-btn join-btn" onclick="window.adminForceStart('${r.id}')">å¼·åˆ¶é–‹å§‹</button>
                            <button class="action-btn warn-btn" onclick="window.adminResetTurn('${r.id}')">é‡ç½®å›åˆ</button>
                            <button class="action-btn delete-btn" onclick="window.adminDeleteRoom('${r.id}')">åˆªé™¤</button>
                        </div>
                     </div>`;
                 });
             });
        }

    </script>
</body>
</html>
