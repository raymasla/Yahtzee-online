<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Yahtzee Pro</title>
    <style>
        :root {
            /* æ ¸å¿ƒè‰²ç¥¨ï¼šæš—é»‘è—è‰²ç³» */
            --bg-color: #0f172a;        /* æ·±å²©è—èƒŒæ™¯ */
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --panel-bg: #1e293b;        /* é¢æ¿èƒŒæ™¯ */
            --text-color: #e2e8f0;      /* æ·ºç°ç™½æ–‡å­— */
            --text-muted: #94a3b8;      /* æ¬¡è¦æ–‡å­— */
            
            --accent-color: #0ea5e9;    /* å¤©ç©ºè— (ä¸»è¦å‹•ä½œ) */
            --accent-dark: #0284c7;     /* å¤©ç©ºè—æ·±è‰² (æŒ‰éˆ•é™°å½±) */
            
            --confirm-color: #10b981;   /* ç¿¡ç¿ ç¶  (ç¢ºèª/åŠ å…¥) */
            --confirm-dark: #059669;
            
            --danger-color: #ef4444;    /* èµ¤ç´… (é€€å‡º/åˆªé™¤) */
            --danger-dark: #b91c1c;
            
            --admin-color: #8b5cf6;     /* ç´«ç¾…è˜­ (ç®¡ç†å“¡) */
            --info-color: #64748b;      /* è—ç° (è³‡è¨Š) */

            --die-size: 46px;           /* ç¨å¾®åŠ å¤§éª°å­ */
            --die-base-color: #f8fafc;
            --dot-color: #1e293b;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-color);
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* é€šç”¨å‹•ç•« */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .view-section {
            width: 100%;
            max-width: 650px;
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-bottom: 60px;
            /* é é¢åˆ‡æ›å‹•ç•« */
            animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .active-view { display: flex; }

        h1 { 
            margin: 10px 0 20px 0; 
            color: var(--text-color); 
            font-size: 1.8rem; 
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 1px;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 5px;
            display: inline-block;
        }

        h2 { margin: 10px 0; font-size: 1.3rem; color: var(--text-muted); font-weight: 600; }
        
        /* æŒ‰éˆ•æ¨£å¼å„ªåŒ– - 3D æ‰å¹³é¢¨æ ¼ */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 85%;
            margin-top: 25px;
        }
        
        .menu-btn {
            background: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid #334155;
            padding: 16px;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            position: relative;
            box-shadow: 0 4px 0 #0f172a; /* ç¡¬é™°å½±ï¼Œç„¡å…‰æšˆ */
        }
        
        .menu-btn:active { 
            transform: translateY(4px); 
            box-shadow: 0 0 0 transparent; 
        }

        .menu-btn.primary { 
            background: var(--accent-color); 
            border-color: var(--accent-dark); 
            box-shadow: 0 4px 0 var(--accent-dark);
            color: white;
        }
        
        .menu-btn.info { 
            background: var(--info-color); 
            border-color: #475569;
            box-shadow: 0 4px 0 #334155;
        }

        .menu-btn.admin-btn {
            background: var(--admin-color);
            border-color: #7c3aed;
            box-shadow: 0 4px 0 #6d28d9;
            display: none;
        }
        .menu-btn.admin-btn.visible { display: block; }

        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input[type="text"], input[type="number"], input[type="password"], select {
            background: #0f172a;
            color: white;
            padding: 12px;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #334155;
            width: 85%;
            margin-bottom: 12px;
            text-align: center;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* åˆ—è¡¨å®¹å™¨ */
        .room-list {
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .room-item {
            background: #283649;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--accent-color);
            transition: background 0.2s;
        }
        .room-item:hover { background: #334155; }
        
        .room-item.leaderboard-item {
            display: grid;
            grid-template-columns: 1fr 70px 70px;
            gap: 10px;
            text-align: left;
            border-left: none;
            border-bottom: 2px solid #1e293b;
            background: transparent;
        }

        .room-status { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;}
        
        /* å°æŒ‰éˆ• */
        .action-btn {
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: filter 0.2s;
            box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        .action-btn:hover { filter: brightness(1.1); }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }

        .join-btn { background: var(--confirm-color); }
        .view-btn { background: var(--info-color); }
        .delete-btn { background: var(--danger-color); margin-left: 5px;}
        .warn-btn { background: #d97706; margin-left: 5px; }

        /* --- Dice 3D Styles (Refined) --- */
        .dice-board {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            perspective: 800px;
            height: var(--die-size);
            padding: 10px;
            /* è®“éª°å­å€åŸŸçœ‹èµ·ä¾†åƒå€‹å‡¹æ§½ */
            background: rgba(0,0,0,0.2);
            border-radius: 50px;
            border: 1px solid #334155;
        }

        .cube-wrapper { 
            width: var(--die-size); 
            height: var(--die-size); 
            cursor: pointer; 
        }
        
        .cube {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transform: rotateX(0deg) rotateY(0deg);
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1.1); /* æ›´æœ‰å½ˆæ€§çš„å‹•ç•« */
        }
        
        .face {
            position: absolute; 
            width: var(--die-size); 
            height: var(--die-size);
            background: var(--die-base-color); 
            border: 1px solid #cbd5e1;
            border-radius: 8px; 
            /* è¼•å¾®çš„å…§éƒ¨é™°å½±å¢åŠ å¯¦é«”æ„Ÿï¼Œéå…‰æšˆ */
            box-shadow: inset 0 0 8px rgba(0,0,0,0.15); 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(3, 1fr);
            padding: 4px; 
            box-sizing: border-box;
            gap: 2px;
        }
        
        .dot {
            background-color: var(--dot-color); 
            border-radius: 50%;
            width: 100%; height: 100%;
            display: block;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.8); /* é»çš„å‡¹é™·æ„Ÿ */
        }

        /* éª°å­é»æ•¸é‚è¼¯ä¿æŒä¸è®Š */
        .face-1 .dot:nth-child(1) { grid-area: 2 / 2; }
        .face-2 .dot:nth-child(1) { grid-area: 1 / 1; } .face-2 .dot:nth-child(2) { grid-area: 3 / 3; }
        .face-3 .dot:nth-child(1) { grid-area: 1 / 1; } .face-3 .dot:nth-child(2) { grid-area: 2 / 2; } .face-3 .dot:nth-child(3) { grid-area: 3 / 3; }
        .face-4 .dot:nth-child(1) { grid-area: 1 / 1; } .face-4 .dot:nth-child(2) { grid-area: 1 / 3; } .face-4 .dot:nth-child(3) { grid-area: 3 / 1; } .face-4 .dot:nth-child(4) { grid-area: 3 / 3; }
        .face-5 .dot:nth-child(1) { grid-area: 1 / 1; } .face-5 .dot:nth-child(2) { grid-area: 1 / 3; } .face-5 .dot:nth-child(3) { grid-area: 2 / 2; } .face-5 .dot:nth-child(4) { grid-area: 3 / 1; } .face-5 .dot:nth-child(5) { grid-area: 3 / 3; }
        .face-6 .dot:nth-child(1) { grid-area: 1 / 1; } .face-6 .dot:nth-child(2) { grid-area: 1 / 3; } .face-6 .dot:nth-child(3) { grid-area: 2 / 1; } .face-6 .dot:nth-child(4) { grid-area: 2 / 3; } .face-6 .dot:nth-child(5) { grid-area: 3 / 1; } .face-6 .dot:nth-child(6) { grid-area: 3 / 3; }

        /* é–å®šç‹€æ…‹ï¼šç´…è‰²é‚Šæ¡†æ”¹ç‚ºæš—ç´…è‰²é®ç½©æ•ˆæœ */
        .locked .face { 
            border-color: var(--danger-color); 
            background-color: #fee2e2; 
            box-shadow: inset 0 0 0 2px var(--danger-color);
        }
        .locked .dot { background-color: #991b1b; }
        
        /* 3D è½‰æ›å€¼å¾®èª¿ä»¥é©æ‡‰æ–°å°ºå¯¸ */
        .front { transform: rotateY(0deg) translateZ(23px); }
        .back { transform: rotateY(180deg) translateZ(23px); }
        .right { transform: rotateY(90deg) translateZ(23px); }
        .left { transform: rotateY(-90deg) translateZ(23px); }
        .top { transform: rotateX(90deg) translateZ(23px); }
        .bottom { transform: rotateX(-90deg) translateZ(23px); }

        /* éŠæˆ²æ§åˆ¶æŒ‰éˆ•å€ */
        .controls { 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
        }
        
        .controls button {
            color: white; border: none; padding: 10px 24px; 
            font-size: 1rem; border-radius: 6px; cursor: pointer; 
            font-weight: bold;
            transition: all 0.1s;
        }
        
        #roll-btn { background: var(--accent-color); box-shadow: 0 4px 0 var(--accent-dark); }
        #confirm-btn { background: var(--confirm-color); box-shadow: 0 4px 0 var(--confirm-dark); }
        #quit-btn { background: var(--danger-color); box-shadow: 0 4px 0 var(--danger-dark); }
        
        .controls button:active { transform: translateY(4px); box-shadow: none !important; }
        .controls button:disabled { 
            background: #475569 !important; 
            box-shadow: none !important; 
            transform: translateY(4px) !important; 
            opacity: 0.5; 
            cursor: not-allowed; 
        }

        /* è¨˜åˆ†æ¿ - ç¾ä»£åŒ–è¨­è¨ˆ */
        .score-board { 
            display: flex; 
            gap: 8px; 
            justify-content: center; 
            align-items: flex-start; 
            width: 100%; 
            max-width: 800px; 
        }
        
        .column { 
            flex: 1; 
            background: var(--panel-bg); 
            padding: 5px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 1px solid #334155;
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0 2px; table-layout: fixed; }
        
        th.player-header {
            font-size: 0.75rem; 
            color: var(--text-muted); 
            text-align: center; 
            padding: 8px 0; 
            border-bottom: 2px solid #334155;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        th.player-header.is-me-header { color: var(--accent-color); font-weight: bold; }
        
        td { 
            padding: 6px 2px; 
            vertical-align: middle; 
            font-size: 0.9rem; 
        }
        
        tr.score-row { 
            transition: background 0.2s; 
            cursor: pointer; 
            border-radius: 4px;
        }
        
        /* æ–‘é¦¬ç´‹èƒŒæ™¯ */
        tr.score-row:nth-child(odd) { background: rgba(255,255,255,0.03); }
        tr.score-row:hover { background: rgba(56, 189, 248, 0.15); }
        
        /* é¸ä¸­è¡Œæ•ˆæœ */
        tr.score-row.selected-row { 
            background: rgba(16, 185, 129, 0.2) !important; 
            box-shadow: inset 2px 0 0 var(--confirm-color);
        }
        
        .score-cell { 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            text-align: center; 
            color: var(--text-color);
            border-left: 1px solid rgba(255,255,255,0.05);
        }
        .score-cell.my-cell { background: rgba(14, 165, 233, 0.05); } 
        
        .preview-text { color: #fbbf24; font-style: italic; animation: pulse 1s infinite; }
        .filled { color: var(--confirm-color); pointer-events: none; }
        
        td.icon-col { width: 40px; text-align: center; }
        
        /* å°åœ–ç¤ºå„ªåŒ– */
        .mini-die { 
            width: 18px; height: 18px; background: #e2e8f0; border-radius: 3px; 
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); 
            padding: 1px; margin: 0 auto; gap: 0.5px; box-sizing: border-box;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .mini-dot { background: #0f172a; border-radius: 50%; width: 100%; height: 100%; }
        /* Mini Die Faces (Keep same logic) */
        .m-d-1 :nth-child(1) { grid-area: 2 / 2; }
        .m-d-2 :nth-child(1) { grid-area: 1 / 1; } .m-d-2 :nth-child(2) { grid-area: 3 / 3; }
        .m-d-3 :nth-child(1) { grid-area: 1 / 1; } .m-d-3 :nth-child(2) { grid-area: 2 / 2; } .m-d-3 :nth-child(3) { grid-area: 3 / 3; }
        .m-d-4 :nth-child(1) { grid-area: 1 / 1; } .m-d-4 :nth-child(2) { grid-area: 1 / 3; } .m-d-4 :nth-child(3) { grid-area: 3 / 1; } .m-d-4 :nth-child(4) { grid-area: 3 / 3; }
        .m-d-5 :nth-child(1) { grid-area: 1 / 1; } .m-d-5 :nth-child(2) { grid-area: 1 / 3; } .m-d-5 :nth-child(3) { grid-area: 2 / 2; } .m-d-5 :nth-child(4) { grid-area: 3 / 1; } .m-d-5 :nth-child(5) { grid-area: 3 / 3; }
        .m-d-6 :nth-child(1) { grid-area: 1 / 1; } .m-d-6 :nth-child(2) { grid-area: 1 / 3; } .m-d-6 :nth-child(3) { grid-area: 2 / 1; } .m-d-6 :nth-child(4) { grid-area: 2 / 3; } .m-d-6 :nth-child(5) { grid-area: 3 / 1; } .m-d-6 :nth-child(6) { grid-area: 3 / 3; }
        
        .symbol-text { font-size: 0.8rem; font-weight: 800; color: #94a3b8; }
        
        #grand-total-display { 
            font-size: 1.4rem; 
            color: #fbbf24; 
            margin-top: 20px; 
            font-weight: bold; 
            padding: 15px; 
            background: #1e293b; 
            border: 1px solid #334155;
            border-radius: 8px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); 
        }

        @media (max-width: 360px) {
            :root { --die-size: 38px; }
            .front { transform: rotateY(0deg) translateZ(19px); } .back { transform: rotateY(180deg) translateZ(19px); }
            /* Mobile adjustment needed */
        }

        /* Overlay & Special Effects - NO GLOW */
        #special-event-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); /* High opacity dark background */
            backdrop-filter: blur(5px);
            z-index: 3000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; pointer-events: none; 
        }
        #special-event-overlay.active { display: flex; pointer-events: auto; animation: fadeIn 0.3s; }
        
        .rainbow-bg {
            /* Replace rainbow with a classy gold/dark gradient */
            background: linear-gradient(135deg, #422006 0%, #a16207 100%);
        }
        
        .cheer-text { 
            font-size: 3.5rem; 
            font-weight: 900; 
            color: #fff; 
            text-transform: uppercase; 
            text-align: center; 
            margin: 0 20px; 
            line-height: 1.2;
            /* Hard shadow text */
            text-shadow: 4px 4px 0px rgba(0,0,0,0.5); 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .sub-cheer { 
            color: #cbd5e1; 
            margin-top: 20px; 
            font-size: 1.5rem; 
            font-weight: bold; 
            text-align: center; 
        }
        
        /* Confetti - Flat squares */
        .confetti { position: absolute; width: 12px; height: 12px; background: #ef4444; animation: fall linear forwards; z-index: 3001; opacity: 0.9; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* Admin & Players Bar */
        .players-bar { 
            display: flex; width: 100%; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; 
            scrollbar-width: thin; scrollbar-color: #334155 transparent;
        }
        
        .player-badge { 
            background: #1e293b; 
            color: #94a3b8;
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            white-space: nowrap; 
            border: 1px solid #334155; 
            transition: all 0.3s;
        }
        
        .player-badge.active-turn { 
            border-color: var(--accent-color); 
            background: #0c4a6e; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Admin Panels & Areas */
        #admin-panel { display: none; margin-top: 15px; padding: 15px; background: #2e1065; border: 1px solid #7c3aed; border-radius: 8px; flex-direction: column; align-items: center; width: 90%; max-width: 400px; }
        #admin-panel.active { display: flex; }
        .admin-dice-inputs { display: flex; gap: 5px; margin-bottom: 5px; }
        .admin-die-input { width: 30px !important; padding: 5px !important; margin: 0 !important; text-align: center; }

        /* BUG FIX: Admin Controls Area (Challenge Create) - Default Hidden */
        .admin-controls-area { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px; 
            width: 100%; 
            margin-bottom: 15px; 
            background: rgba(139, 92, 246, 0.1);
            border: 1px dashed var(--admin-color);
            padding: 15px;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .admin-controls-area.active { display: flex; }

        /* Settings & Create Room */
        .create-room-panel {
            width: 100%; 
            margin: 10px 0; 
            background: var(--panel-bg); 
            padding: 20px; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            border: 1px solid #334155;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .setting-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 1rem;
            color: #cbd5e1;
        }
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .checkbox-wrapper input {
            width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent-color);
        }

        /* NUMPAD CUSTOM STYLES */
        .numpad-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 5000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .numpad-box {
            background: #1e293b;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 340px;
            border: 1px solid #334155;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center;
        }
        .numpad-title {
            color: white; font-size: 1.2rem; margin-bottom: 15px; font-weight: bold;
        }
        .numpad-display {
            background: #0f172a;
            color: var(--accent-color);
            font-size: 2rem;
            letter-spacing: 6px;
            padding: 15px;
            width: 100%;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            min-height: 50px;
            border: 1px solid #334155;
            font-family: monospace;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
        }
        .num-btn {
            background: #334155;
            color: white;
            border: 1px solid #475569;
            padding: 16px 0;
            font-size: 1.4rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            font-weight: bold;
            box-shadow: 0 4px 0 #1e293b;
        }
        .num-btn:active { background: var(--accent-color); transform: translateY(4px); box-shadow: none; }
        .num-btn.action-key { font-size: 1rem; background: #1e293b; }
        .num-btn.confirm-key { 
            grid-column: span 3; 
            background: var(--confirm-color); 
            border-color: var(--confirm-dark);
            margin-top: 5px;
            box-shadow: 0 4px 0 var(--confirm-dark);
        }
        .num-btn.close-key {
             background: var(--danger-color); border-color: var(--danger-dark);
             box-shadow: 0 4px 0 var(--danger-dark);
        }
        
        /* Modal Style */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box { 
            background: #1e293b; 
            padding: 25px; 
            border-radius: 12px; 
            width: 80%; 
            max-width: 320px; 
            text-align: center; 
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body>

    <div id="special-event-overlay">
        <div id="overlay-title" class="cheer-text"></div>
        <div id="overlay-sub" class="sub-cheer"></div>
    </div>

    <div id="custom-numpad" class="numpad-overlay">
        <div class="numpad-box">
            <div id="numpad-title" class="numpad-title">è¼¸å…¥å¯†ç¢¼</div>
            <div id="numpad-display" class="numpad-display"></div>
            <div class="numpad-grid">
                <button class="num-btn" onclick="npInput('1')">1</button>
                <button class="num-btn" onclick="npInput('2')">2</button>
                <button class="num-btn" onclick="npInput('3')">3</button>
                <button class="num-btn" onclick="npInput('4')">4</button>
                <button class="num-btn" onclick="npInput('5')">5</button>
                <button class="num-btn" onclick="npInput('6')">6</button>
                <button class="num-btn" onclick="npInput('7')">7</button>
                <button class="num-btn" onclick="npInput('8')">8</button>
                <button class="num-btn" onclick="npInput('9')">9</button>
                <button class="num-btn action-key close-key" onclick="npClose()">å–æ¶ˆ</button>
                <button class="num-btn" onclick="npInput('0')">0</button>
                <button class="num-btn action-key" onclick="npDel()">â†</button>
                <button class="num-btn confirm-key" onclick="npConfirm()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="landing-view" class="view-section active-view">
        <h1>ğŸ² 3D Yahtzee Pro</h1>
        <div class="btn-group">
            <button class="menu-btn primary" onclick="goToNickname()">é€£ç·šå°æˆ° (åŒ¹é…æ¨¡å¼)</button>
            <button class="menu-btn" onclick="showChallengeLobby()">æŒ‘æˆ°æ“‚å° (æ’è¡Œæ¦œ)</button>
            <button class="menu-btn" onclick="startSoloGame()">å–®äººç·´ç¿’ (Solo)</button>
            <button class="menu-btn info" onclick="showTutorial()">æŸ¥çœ‹éŠæˆ²è¦å‰‡</button>
            <button id="admin-entry-btn" class="menu-btn admin-btn" onclick="showAdminRoomManager()">ğŸ”´ æˆ¿é–“ç®¡ç† (yahtzee_rooms)</button>
        </div>
    </div>

    <div id="admin-room-view" class="view-section">
        <h1 style="color: var(--admin-color)">ğŸ”§ ç®¡ç†å“¡å¾Œå° (å¤šäºº)</h1>
        <div class="room-list" id="admin-room-list" style="max-height: 400px; background: transparent; border:none; box-shadow:none;"></div>
        <div class="btn-group">
            <button class="menu-btn" onclick="showView('landing-view')">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="nickname-view" class="view-section">
        <h1>è¼¸å…¥æš±ç¨±</h1>
        <input type="text" id="nickname-input" placeholder="ä¾‹å¦‚ï¼šéª°å­ç‹é˜¿æ˜" maxlength="8">
        <div class="btn-group">
            <button class="menu-btn primary" onclick="enterLobby()">é€²å…¥å¤§å»³</button>
            <button class="menu-btn" onclick="showView('landing-view')">è¿”å›</button>
        </div>
    </div>

    <div id="lobby-view" class="view-section">
        <h1>éŠæˆ²å¤§å»³</h1>
        <p>æ­¡è¿, <span id="lobby-nickname" style="color:var(--accent-color); font-weight:bold;"></span></p>
        
        <div class="create-room-panel">
            <div style="font-weight:bold; color:var(--text-muted); border-bottom:1px solid #334155; padding-bottom:10px; margin-bottom:5px;">å‰µå»ºæˆ¿é–“è¨­å®š</div>
            
            <div class="setting-row">
                <label>ç©å®¶äººæ•¸:</label>
                <select id="player-count-select">
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                    <option value="4">4äºº</option>
                </select>
            </div>

            <div class="setting-row">
                <label>æ¯å›åˆæ“²éª°:</label>
                <select id="rolls-setting-select">
                    <option value="1">1æ¬¡ </option>
                    <option value="2">2æ¬¡ </option>
                    <option value="3" selected>3æ¬¡*é è¨­</option>
                    <option value="4">4æ¬¡ </option>
                    <option value="5">5æ¬¡ </option>
		    <option value="7">7æ¬¡ </option>
		    <option value="10">10æ¬¡ </option>
                </select>
            </div>

            <div class="setting-row" style="justify-content: center;">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="bonus-yahtzee-check" checked>
                    <span>é–‹å•Ÿé‡è¤‡ Yahtzee (+100)</span>
                </label>
            </div>

            <button class="action-btn join-btn" style="font-size:1rem; padding:12px; width:100%; margin-top:10px; box-shadow: 0 4px 0 var(--confirm-dark);" onclick="createRoom()">å‰µç«‹æˆ¿é–“</button>
        </div>

        <div style="width: 100%; margin: 15px 0;">
            <div style="text-align:left; color:var(--text-muted); font-size:0.9rem; margin-bottom:8px; font-weight:600;">ç¾æœ‰æˆ¿é–“åˆ—è¡¨:</div>
            <div id="room-list-container" class="room-list"></div>
        </div>
        <button class="menu-btn" onclick="showView('landing-view')" style="margin-top: 20px; padding: 10px 20px;">é›¢é–‹</button>
    </div>

    <div id="waiting-view" class="view-section">
        <h1>ç­‰å¾…åŠ å…¥ä¸­...</h1>
        <p>æˆ¿é–“ ID: <span id="wait-room-id" style="color: #fbbf24; font-family: monospace; font-size: 1.2rem;"></span></p>
        <p>è¦å‰‡: <span id="wait-rules-display" style="color: var(--accent-color); font-size:0.9rem;"></span></p>
        <p>ç©å®¶: <span id="wait-player-count">1</span> / <span id="wait-max-players">2</span></p>
        <div class="room-list" id="wait-player-list"></div>
        <div class="btn-group">
            <button id="host-start-btn" class="menu-btn primary" style="display:none;" onclick="manualStartGame()">é–‹å§‹éŠæˆ² (æ‰‹å‹•)</button>
            <button class="menu-btn" style="background:var(--danger-color); border-color:var(--danger-dark); box-shadow: 0 4px 0 var(--danger-dark);" onclick="leaveWaitingRoom()">é›¢é–‹æˆ¿é–“</button>
        </div>
    </div>

    <div id="challenge-lobby-view" class="view-section">
        <h1>ğŸ† æŒ‘æˆ°æ“‚å°</h1>
        
        <div id="admin-challenge-controls" class="admin-controls-area">
            <h3 style="color:var(--admin-color); margin:0;">ç®¡ç†å“¡ï¼šå‰µå»ºæ“‚å°</h3>
            <input type="text" id="new-challenge-name" placeholder="æ“‚å°åç¨± (å¦‚: é€±æœ«ç›ƒ)" style="width:90%">
            <input type="text" id="new-challenge-pass" placeholder="è¨­å®šå¯†ç¢¼ (é»æ“Šè¼¸å…¥)" style="width:90%; cursor:pointer; background:#0f172a; color:#ecf0f1;" readonly onclick="triggerNumpadForInput(this)">
            <button class="action-btn join-btn" onclick="createChallengeRoom()">å»ºç«‹</button>
        </div>

        <div class="room-list" id="challenge-room-list">
            <div style="padding:10px; color:#aaa;">è®€å–æ“‚å°ä¸­...</div>
        </div>
        
        <div class="btn-group">
            <button class="menu-btn" onclick="showView('landing-view')">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="challenge-room-detail" class="view-section">
        <h2 id="c-room-title">æ“‚å°è©³æƒ…</h2>
        <p style="font-size:0.8rem; color:#aaa;">ID: <span id="c-room-id"></span></p>
        
        <div class="room-list" id="c-leaderboard-list">
            </div>

        <div class="btn-group">
            <button class="menu-btn primary" onclick="promptChallengeStart()">âš”ï¸ æˆ‘è¦æŒ‘æˆ°</button>
            <button class="menu-btn" onclick="showChallengeLobby()">è¿”å›åˆ—è¡¨</button>
        </div>
    </div>

    <div id="tutorial-view" class="view-section">
        <h1>ğŸ“œ éŠæˆ²æ•™å­¸</h1>
        <div class="tutorial-content" style="text-align: left; background: var(--panel-bg); padding: 20px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; height: 350px; overflow-y: auto; width: 90%; border:1px solid #334155;">
            <h3 style="color:var(--accent-color); border-bottom:1px solid #334155;">éŠæˆ²ç›®æ¨™</h3>
            <p>æ“²éª°å­ä¸¦åœ¨è¨˜åˆ†æ¿ä¸Šç²å¾—æœ€é«˜åˆ†ã€‚éŠæˆ²å…± 13 å›åˆã€‚</p>
            <h3 style="color:var(--accent-color); border-bottom:1px solid #334155;">å›åˆæµç¨‹</h3>
            <ul>
                <li>æ¯å›åˆæœ‰ 3 æ¬¡æ“²éª°æ©Ÿæœƒ (å‰µæˆ¿è€…å¯èª¿æ•´)ã€‚</li>
                <li>é»æ“Šéª°å­å¯ä»¥ã€Œé–å®š/è§£é–ã€ä¿ç•™é»æ•¸ã€‚</li>
                <li>æœ€å¾Œä¸€æ¬¡æ“²éª°å¾Œï¼ˆæˆ–æå‰ï¼‰ï¼Œå¿…é ˆåœ¨è¨˜åˆ†æ¿é¸æ“‡ä¸€æ ¼å¡«åˆ†ã€‚</li>
            </ul>
            <h3 style="color:var(--accent-color); border-bottom:1px solid #334155;">è¨ˆåˆ†è¦å‰‡ (å·¦åŠé‚Š)</h3>
            <p>å°æ‡‰é»æ•¸ç¸½å’Œã€‚è‹¥ä¸Šå±¤ç¸½åˆ† >= 63ï¼Œé¡å¤–ç²å¾— 35 åˆ†çå‹µã€‚</p>
            <h3 style="color:var(--accent-color); border-bottom:1px solid #334155;">è¨ˆåˆ†è¦å‰‡ (å³åŠé‚Š)</h3>
            <ul>
                <li>3X (ä¸‰æ¢): 3é¡†ç›¸åŒï¼Œç¸½å’Œè¨ˆåˆ†ã€‚</li>
                <li>4X (å››æ¢): 4é¡†ç›¸åŒï¼Œç¸½å’Œè¨ˆåˆ†ã€‚</li>
                <li>ğŸ  (è‘«è˜†): 3åŒ+2åŒï¼Œå›ºå®š 25 åˆ†ã€‚</li>
                <li>å°é †: 4é€£è™Ÿï¼Œå›ºå®š 30 åˆ†ã€‚</li>
                <li>å¤§é †: 5é€£è™Ÿï¼Œå›ºå®š 40 åˆ†ã€‚</li>
                <li>Y! (Yahtzee): 5é¡†ç›¸åŒï¼Œå›ºå®š 50 åˆ†ã€‚</li>
                <li>? (æ©Ÿæœƒ): æ‰€æœ‰éª°å­ç¸½å’Œã€‚</li>
            </ul>
            <h3 style="color:var(--accent-color); border-bottom:1px solid #334155;">ç‰¹æ®Šçå‹µ</h3>
            <p>è‹¥åœ¨æ“²å‡ºå¤šæ¬¡ Yahtzeeï¼Œä¸” Y! æ ¼å·²å¡«æ»¿ 50 åˆ†ï¼Œæ¯æ¬¡é¡å¤– +100 åˆ† (è‹¥æˆ¿é–“è¨­å®šé–‹å•Ÿ)ï¼</p>
        </div>
        <div class="btn-group">
            <button class="menu-btn" onclick="showView('landing-view')">æ˜ç™½ï¼Œé–‹å§‹ç©ï¼</button>
        </div>
    </div>

    <div id="game-view" class="view-section">
        <div class="players-bar" id="ingame-players-bar"></div>
        <div id="turn-indicator" style="background: #0f172a; color: white; padding: 8px 20px; border-radius: 30px; margin-bottom: 10px; border:1px solid #334155; font-weight:bold;">å–®äººæ¨¡å¼</div>
        
        <div class="dice-board" id="dice-container"></div>

        <div class="controls" id="game-controls">
            <button id="roll-btn" onclick="handleRollClick()">æ“²éª° (<span id="rolls-left">3</span>)</button>
            <button id="confirm-btn" onclick="handleConfirmClick()" disabled>ç¢ºèª</button>
            <button id="quit-btn" onclick="quitGame()">é€€å‡º</button>
        </div>
        
        <div class="controls" id="record-controls" style="display:none;">
            <button class="menu-btn" onclick="exitRecordView()">é—œé–‰æŸ¥çœ‹</button>
        </div>

        <div id="admin-panel">
            <div style="color: #a78bfa; font-weight: bold; margin-bottom:5px;">ğŸ‘¾ God Mode</div>
            <div class="admin-dice-inputs">
                <input type="number" id="admin-d0" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d1" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d2" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d3" class="admin-die-input" min="1" max="6" placeholder="?">
                <input type="number" id="admin-d4" class="admin-die-input" min="1" max="6" placeholder="?">
            </div>
            <div style="display:flex; gap:10px;">
                <label style="color:#fbbf24"><input type="checkbox" id="admin-infinite-rolls"> ç„¡é™æ“²éª°</label>
            </div>
        </div>

        <div class="score-board">
            <div class="column">
                <table><tbody id="upper-section"></tbody></table>
            </div>
            <div class="column">
                <table><tbody id="lower-section"></tbody></table>
            </div>
        </div>

        <div id="grand-total-display">ç¸½åˆ†: <span id="grand-total">0</span></div>
    </div>

    <div id="challenge-name-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>è¼¸å…¥æŒ‘æˆ°æš±ç¨±</h3>
            <input type="text" id="challenge-nickname-input" placeholder="åç¨±" maxlength="8" style="width:90%; color:white;">
            <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                <button class="action-btn join-btn" style="padding:10px 20px;" onclick="confirmChallengeStart()">é–‹å§‹</button>
                <button class="action-btn delete-btn" style="padding:10px 20px;" onclick="document.getElementById('challenge-name-modal').style.display='none'">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7PZLTTNf17cfp9gCHudWiWX8SYPSCdDI",
            authDomain: "onlineeasyraygame.firebaseapp.com",
            databaseURL: "https://onlineeasyraygame-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "onlineeasyraygame",
            storageBucket: "onlineeasyraygame.firebasestorage.app",
            messagingSenderId: "622138442346",
            appId: "1:622138442346:web:9e29ef572d334f83428013",
            measurementId: "G-ZT703DH0ZS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const ROOMS_ROOT = "yahtzee_rooms";
        const CHALLENGE_ROOT = "challenge_rooms";

        // Global State
        let myNickname = "";
        let myPlayerId = "";
        let currentRoomId = "";
        let currentRoomData = null;
        let isMyTurn = false;
        
        // Game Modes: 'multiplayer', 'solo', 'challenge', 'view_record'
        let currentGameMode = 'solo'; 
        
        // Admin State
        let isAdmin = false;
        let isWangTester = false;
        let keyBuffer = "";
        const SECRET_CODE = "991020";

        // Challenge Specifics
        let currentChallengeRoomId = null;
        let currentChallengeLeaderboard = []; // Cache for duplicate checking

        // Solo / Local Game State (Used for Solo & Challenge)
        let soloState = {
            dice: [1, 1, 1, 1, 1],
            locked: [false, false, false, false, false],
            rollsLeft: 3,
            isRolling: false,
            board: {},
            score: 0
        };
        let localSelection = null; 

        // --- Numpad Logic ---
        let npBuffer = "";
        let npCallback = null;
        let npTargetInput = null; // For filling specific input fields

        window.openNumpad = (title, callback) => {
            document.getElementById('numpad-title').innerText = title || "è¼¸å…¥å¯†ç¢¼";
            npBuffer = "";
            npCallback = callback;
            npTargetInput = null;
            updateNumpadDisplay();
            document.getElementById('custom-numpad').style.display = 'flex';
        };

        window.triggerNumpadForInput = (inputElement) => {
            npTargetInput = inputElement;
            npBuffer = inputElement.value || "";
            document.getElementById('numpad-title').innerText = "è¨­å®šå¯†ç¢¼";
            updateNumpadDisplay();
            document.getElementById('custom-numpad').style.display = 'flex';
            
            // Callback handles closing and updating value
            npCallback = (val) => {
                if(npTargetInput) npTargetInput.value = val;
            };
        };

        window.npInput = (num) => {
            if(npBuffer.length < 10) npBuffer += num;
            updateNumpadDisplay();
        };

        window.npDel = () => {
            if(npBuffer.length > 0) npBuffer = npBuffer.slice(0, -1);
            updateNumpadDisplay();
        };

        window.npClose = () => {
            document.getElementById('custom-numpad').style.display = 'none';
            npBuffer = "";
            npCallback = null;
            npTargetInput = null;
        };

        window.npConfirm = () => {
            const val = npBuffer;
            if(npCallback) npCallback(val);
            document.getElementById('custom-numpad').style.display = 'none';
        };

        function updateNumpadDisplay() {
            // If it's for setting password (input field), show number, else show asterisks
            if (npTargetInput) {
                document.getElementById('numpad-display').innerText = npBuffer;
            } else {
                // Password Masking
                document.getElementById('numpad-display').innerText = "*".repeat(npBuffer.length);
            }
        }


        // --- 1. Event Listeners & Init ---

        window.addEventListener('keydown', (e) => {
            if(document.getElementById('landing-view').classList.contains('active-view')) {
                if(e.key >= "0" && e.key <= "9") {
                    keyBuffer += e.key;
                    if(keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);
                    if(keyBuffer.endsWith(SECRET_CODE)) {
                        enableAdminMode();
                        keyBuffer = ""; 
                    }
                }
            }
        });

        function enableAdminMode() {
            if(isAdmin) return;
            isAdmin = true;
            document.getElementById('admin-entry-btn').classList.add('visible');
            document.querySelectorAll('.admin-controls-area').forEach(e => e.classList.add('active'));
            // FIX: If we are already in the game view, show the panel immediately
            if(document.getElementById('game-view').classList.contains('active-view')) {
                document.getElementById('admin-panel').classList.add('active');
            }
            alert("God Mode Enabled");
        }

        window.showView = (id) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active-view');
        };

        window.showTutorial = () => showView('tutorial-view');

        // --- 2. Multiplayer Logic (Existing/Adapted) ---

        window.goToNickname = () => {
            currentGameMode = 'multiplayer';
            if (isWangTester) {
                myNickname = "æ±ª(æ¸¬è©¦å“¡)";
                myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
                document.getElementById('lobby-nickname').innerText = myNickname;
                showView('lobby-view');
                listenToMultiplayerRooms();
            } else {
                showView('nickname-view');
            }
        };

        window.enterLobby = () => {
            const input = document.getElementById('nickname-input');
            const val = input.value.trim();
            if(!val) { alert("è«‹è¼¸å…¥æš±ç¨±"); return; }
            
            if (val === "991025") {
                isWangTester = true;
                enableAdminMode();
                alert("æ­¡è¿æ±ªæ¸¬è©¦å“¡");
                showView('landing-view'); 
                input.value = ""; 
                return;
            }

            myNickname = val;
            myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
            document.getElementById('lobby-nickname').innerText = myNickname;
            showView('lobby-view');
            listenToMultiplayerRooms();
        };

        window.createRoom = async () => {
            const playerCount = parseInt(document.getElementById('player-count-select').value);
            const rollsPerTurn = parseInt(document.getElementById('rolls-setting-select').value);
            const bonusYahtzee = document.getElementById('bonus-yahtzee-check').checked;

            const newRoomRef = push(ref(db, ROOMS_ROOT));
            const roomId = newRoomRef.key;
            
            await set(newRoomRef, {
                id: roomId,
                host: myNickname,
                status: "waiting",
                maxPlayers: playerCount,
                config: {
                    maxRolls: rollsPerTurn,
                    allowBonusYahtzee: bonusYahtzee
                },
                currentTurnIndex: 0,
                // Initial game state rollsLeft set to custom config
                gameState: { dice: [1,1,1,1,1], locked: [false,false,false,false,false], rollsLeft: rollsPerTurn, isRolling: false },
                players: {
                    [myPlayerId]: { nickname: myNickname, score: 0, board: {} }
                }
            });
            joinMultiplayerRoom(roomId);
        };

        function listenToMultiplayerRooms() {
            onValue(ref(db, ROOMS_ROOT), (snapshot) => {
                if(!document.getElementById('lobby-view').classList.contains('active-view')) return;
                const list = document.getElementById('room-list-container');
                list.innerHTML = "";
                const data = snapshot.val();
                if(!data) { list.innerHTML = "<div style='color:#666'>ç„¡æˆ¿é–“</div>"; return; }

                Object.values(data).forEach(room => {
                    if(room.status === 'waiting') {
                        const count = room.players ? Object.keys(room.players).length : 0;
                        const div = document.createElement('div');
                        const maxRolls = room.config?.maxRolls || 3;
                        const bonus = (room.config?.allowBonusYahtzee !== false) ? 'æœ‰åŠ åˆ†' : 'ç„¡åŠ åˆ†';
                        div.className = 'room-item';
                        div.innerHTML = `
                            <div>
                                <span style="font-weight:bold; color:var(--text-color);">${room.host}</span> <span class="room-status">${count}/${room.maxPlayers}</span>
                                <div style="font-size:0.75rem; color:#64748b; margin-top:2px;">${maxRolls}éª° | ${bonus}</div>
                            </div>
                            <button class="action-btn join-btn" onclick="window.tryJoin('${room.id}')">åŠ å…¥</button>
                        `;
                        list.appendChild(div);
                    }
                });
            });
        }

        window.tryJoin = async (roomId) => {
            const roomRef = ref(db, `${ROOMS_ROOT}/${roomId}`);
            const snapshot = await get(roomRef);
            if(!snapshot.exists()) { alert("æˆ¿é–“ä¸å­˜åœ¨"); return; }
            const room = snapshot.val();
            if(room.status !== 'waiting') { alert("éŠæˆ²å·²é–‹å§‹"); return; }
            if(Object.keys(room.players || {}).length >= room.maxPlayers) { alert("æˆ¿é–“å·²æ»¿"); return; }

            // Bug fix: Removed manual index assignment to avoid race conditions
            await update(ref(db, `${ROOMS_ROOT}/${roomId}/players/${myPlayerId}`), {
                nickname: myNickname, score: 0, board: {}
            });
            joinMultiplayerRoom(roomId);
        };

        function joinMultiplayerRoom(roomId) {
            currentRoomId = roomId;
            const roomRef = ref(db, `${ROOMS_ROOT}/${roomId}`);
            onDisconnect(ref(db, `${ROOMS_ROOT}/${roomId}/players/${myPlayerId}`)).remove();

            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) { 
                    if(currentGameMode === 'multiplayer') { alert("æˆ¿é–“å·²è§£æ•£"); showView('lobby-view'); }
                    return; 
                }
                currentRoomData = data;
                
                // Event Handling (Yahtzee)
                if (data.lastEvent && data.lastEvent.id > (window.lastProcessedEventId || 0)) {
                    window.lastProcessedEventId = data.lastEvent.id;
                    if (data.lastEvent.type === 'YAHTZEE') showOverlay(`YAHTZEE!`, `${data.lastEvent.nickname} éª°å‡º Yahtzee!`, true, 4000);
                }

                // BUG FIX: Sort players by Key ID (timestamp based) to ensure consistent order across clients
                const players = Object.entries(data.players || {})
                    .map(([key, val]) => ({...val, pid: key}))
                    .sort((a,b) => a.pid.localeCompare(b.pid));
                
                if (data.status === 'waiting') {
                    showView('waiting-view');
                    document.getElementById('wait-room-id').innerText = roomId.slice(-4);
                    document.getElementById('wait-player-count').innerText = players.length;
                    document.getElementById('wait-max-players').innerText = data.maxPlayers;
                    
                    // Show rules in waiting room
                    const rMax = data.config?.maxRolls || 3;
                    const rBonus = (data.config?.allowBonusYahtzee !== false) ? "é–‹å•Ÿ" : "é—œé–‰";
                    document.getElementById('wait-rules-display').innerText = `æ¯å›åˆ${rMax}éª° / é‡è¤‡Y!åŠ åˆ†:${rBonus}`;

                    document.getElementById('wait-player-list').innerHTML = players.map(p => `<div class="room-item">${p.nickname} ${p.nickname===myNickname?'(ä½ )':''}</div>`).join('');
                    
                    if(myNickname === data.host) {
                        document.getElementById('host-start-btn').style.display = 'block';
                        if(players.length >= data.maxPlayers) update(roomRef, { status: 'playing' });
                    }
                } else if (data.status === 'playing') {
                    if(!document.getElementById('game-view').classList.contains('active-view')) {
                        initGameUI('multiplayer');
                        showView('game-view');
                        // FIX: Ensure admin panel shows if user is already admin
                        if(isAdmin) document.getElementById('admin-panel').classList.add('active');
                    }
                    syncMultiplayerUI(data, players);
                    checkGameOver(players);
                }
            });
        }

        window.leaveWaitingRoom = async () => {
            if(currentRoomId) await remove(ref(db, `${ROOMS_ROOT}/${currentRoomId}/players/${myPlayerId}`));
            currentRoomId = ""; showView('lobby-view');
        };

        window.manualStartGame = async () => {
            if(currentRoomId) update(ref(db, `${ROOMS_ROOT}/${currentRoomId}`), { status: 'playing' });
        };

        // --- 3. Challenge Arena Logic (New) ---

        window.showChallengeLobby = () => {
            showView('challenge-lobby-view');
            // Listen for rooms
            onValue(ref(db, CHALLENGE_ROOT), (snapshot) => {
                const list = document.getElementById('challenge-room-list');
                list.innerHTML = "";
                const data = snapshot.val();
                if(!data) { list.innerHTML = "<div style='padding:10px;'>ç›®å‰æ²’æœ‰æ“‚å°ã€‚</div>"; return; }

                Object.keys(data).forEach(key => {
                    const room = data[key];
                    const isProtected = room.password && room.password.trim() !== "";
                    
                    const div = document.createElement('div');
                    div.className = 'room-item';
                    div.innerHTML = `
                        <div style="flex:1;">
                            <div style="font-weight:bold; color:var(--accent-color)">${room.name}</div>
                            <div class="room-status">${isProtected ? 'ğŸ”’ ç§äºº' : 'ğŸ”“ å…¬é–‹'} | æ¦œå–®: ${room.leaderboard ? Object.keys(room.leaderboard).length : 0}äºº</div>
                        </div>
                        <div>
                            <button class="action-btn view-btn" onclick="window.enterChallengeRoom('${key}', '${room.password||''}', '${room.name}')">é€²å…¥</button>
                            ${(isAdmin || isWangTester) ? `<button class="action-btn delete-btn" onclick="window.deleteChallengeRoom('${key}')">åˆªé™¤</button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        };

        window.createChallengeRoom = async () => {
            const name = document.getElementById('new-challenge-name').value.trim();
            const pass = document.getElementById('new-challenge-pass').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥åç¨±"); return; }
            
            const newRef = push(ref(db, CHALLENGE_ROOT));
            await set(newRef, {
                name: name,
                password: pass,
                createdAt: Date.now()
            });
            document.getElementById('new-challenge-name').value = "";
            document.getElementById('new-challenge-pass').value = "";
        };

        window.deleteChallengeRoom = async (roomId) => {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ“‚å°ï¼Ÿ")) await remove(ref(db, `${CHALLENGE_ROOT}/${roomId}`));
        };

        window.enterChallengeRoom = async (roomId, password, roomName) => {
            const proceed = () => {
                currentChallengeRoomId = roomId;
                document.getElementById('c-room-title').innerText = roomName;
                document.getElementById('c-room-id').innerText = roomId;
                showView('challenge-room-detail');
                loadLeaderboard(roomId);
            };

            if (password && password !== "" && !isAdmin && !isWangTester) {
                // Use Custom Numpad instead of prompt
                window.openNumpad(`è«‹è¼¸å…¥å¯†ç¢¼: ${roomName}`, (inputVal) => {
                    if(inputVal === password) {
                        proceed();
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤");
                    }
                });
            } else {
                proceed();
            }
        };

        function loadLeaderboard(roomId) {
            // Listen to leaderboard
            onValue(ref(db, `${CHALLENGE_ROOT}/${roomId}/leaderboard`), (snapshot) => {
                if(!document.getElementById('challenge-room-detail').classList.contains('active-view')) return;
                
                const list = document.getElementById('c-leaderboard-list');
                list.innerHTML = "";
                const data = snapshot.val();
                currentChallengeLeaderboard = []; // Reset cache

                if(!data) { list.innerHTML = "<div style='padding:10px; color:#aaa'>æš«ç„¡æŒ‘æˆ°ç´€éŒ„</div>"; return; }

                // Convert to array and sort by score desc
                const entries = Object.entries(data).map(([k, v]) => ({key: k, ...v}));
                entries.sort((a,b) => b.score - a.score);
                currentChallengeLeaderboard = entries; // Save for duplicate check

                entries.forEach((entry, idx) => {
                    const div = document.createElement('div');
                    div.className = 'room-item leaderboard-item';
                    
                    let rankColor = "#94a3b8";
                    if(idx===0) rankColor = "#fbbf24"; // Gold
                    else if(idx===1) rankColor = "#e2e8f0"; // Silver
                    else if(idx===2) rankColor = "#b45309"; // Bronze

                    div.innerHTML = `
                        <div style="color:${rankColor}; overflow:hidden; text-overflow:ellipsis;">
                            <span style="font-weight:bold;">#${idx+1}</span> ${entry.nickname}
                        </div>
                        <div style="text-align:center; font-family:monospace; font-weight:bold;">${entry.score}</div>
                        <div style="display:flex; justify-content:flex-end; gap:5px;">
                            <button class="action-btn view-btn" onclick="window.viewPlayerRecord('${entry.key}')">æŸ¥çœ‹</button>
                            ${(isAdmin || isWangTester) ? `<button class="action-btn delete-btn" style="padding:2px 5px;" onclick="window.deleteChallengeEntry('${entry.key}')">X</button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.deleteChallengeEntry = async (entryKey) => {
            if(confirm("ç§»é™¤æ­¤ç´€éŒ„ï¼Ÿ")) await remove(ref(db, `${CHALLENGE_ROOT}/${currentChallengeRoomId}/leaderboard/${entryKey}`));
        };

        window.viewPlayerRecord = (entryKey) => {
            const entry = currentChallengeLeaderboard.find(e => e.key === entryKey);
            if(!entry) return;

            currentGameMode = 'view_record';
            initGameUI('record');
            showView('game-view');
            
            // UI Tweaks for record view
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('record-controls').style.display = 'flex';
            document.getElementById('turn-indicator').innerText = `æŸ¥çœ‹: ${entry.nickname} çš„ç´€éŒ„`;
            document.getElementById('turn-indicator').style.background = "#64748b";
            
            // Render board
            const dummyPlayer = { nickname: entry.nickname, score: entry.score, board: entry.board, isMe: true };
            renderScoreTables([dummyPlayer]);
            document.getElementById('grand-total').innerText = entry.score;
        };

        window.exitRecordView = () => {
            showView('challenge-room-detail');
        };

        window.promptChallengeStart = () => {
            if(isWangTester) {
                startChallengeRun("æ±ª(æ¸¬è©¦å“¡)");
            } else {
                document.getElementById('challenge-name-modal').style.display = 'flex';
                document.getElementById('challenge-nickname-input').focus();
            }
        };

        window.confirmChallengeStart = () => {
            const name = document.getElementById('challenge-nickname-input').value.trim();
            if(!name) { alert("è«‹è¼¸å…¥åç¨±"); return; }

            // Check duplicate
            const exists = currentChallengeLeaderboard.some(e => e.nickname === name);
            if(exists) {
                alert("æ­¤æš±ç¨±å·²åœ¨æ¦œå–®ä¸Šï¼Œè«‹ä½¿ç”¨å…¶ä»–åç¨±ï¼");
                return;
            }

            document.getElementById('challenge-name-modal').style.display = 'none';
            startChallengeRun(name);
        };

        function startChallengeRun(nickname) {
            myNickname = nickname;
            currentGameMode = 'challenge';
            
            // Reset Solo State
            soloState = {
                dice: [1, 1, 1, 1, 1],
                locked: [false, false, false, false, false],
                rollsLeft: 3,
                isRolling: false,
                board: {},
                score: 0
            };
            localSelection = null;

            initGameUI('challenge');
            showView('game-view');
            
            document.getElementById('turn-indicator').innerText = "æŒ‘æˆ°é–‹å§‹ï¼";
            document.getElementById('turn-indicator').style.background = "#ef4444";
            document.getElementById('ingame-players-bar').innerHTML = `<div class="player-badge active-turn is-me">${myNickname}</div>`;
            document.getElementById('rolls-left').innerText = "3";
            document.getElementById('roll-btn').disabled = false;
            document.getElementById('confirm-btn').disabled = true;
            
            if(isAdmin) document.getElementById('admin-panel').classList.add('active');
            
            updateDiceVisuals(soloState.dice, false, soloState.locked);
            renderScoreTables([{ nickname: myNickname, score: 0, board: {}, isMe: true }]);
        }


        // --- 4. Solo / Challenge Game Logic ---

        window.startSoloGame = () => {
            currentGameMode = 'solo';
            myNickname = "ç·´ç¿’è€…";
            
            soloState = {
                dice: [1, 1, 1, 1, 1],
                locked: [false, false, false, false, false],
                rollsLeft: 3,
                isRolling: false,
                board: {},
                score: 0
            };
            localSelection = null;

            initGameUI('solo');
            showView('game-view');
            if(isAdmin) document.getElementById('admin-panel').classList.add('active');
            
            document.getElementById('turn-indicator').innerText = "å–®æ©Ÿç·´ç¿’æ¨¡å¼";
            document.getElementById('turn-indicator').style.background = "#10b981";
            document.getElementById('ingame-players-bar').innerHTML = `<div class="player-badge active-turn is-me">${myNickname}</div>`;
            
            updateDiceVisuals(soloState.dice, false, soloState.locked);
            renderScoreTables([{ nickname: myNickname, score: 0, board: {}, isMe: true }]);
        };

        window.quitGame = async () => {
            if(!confirm("ç¢ºå®šè¦é€€å‡ºéŠæˆ²å—ï¼Ÿ")) return;
            
            if(currentGameMode === 'multiplayer' && currentRoomId) {
                await remove(ref(db, `${ROOMS_ROOT}/${currentRoomId}/players/${myPlayerId}`));
                location.reload();
            } else if (currentGameMode === 'challenge') {
                showView('challenge-room-detail'); // Go back to leaderboard without saving
            } else {
                location.reload(); // Solo
            }
        };

        // --- 5. Shared Game Core ---

        function initGameUI(mode) {
            document.getElementById('game-controls').style.display = 'flex';
            document.getElementById('record-controls').style.display = 'none';
            const container = document.getElementById('dice-container');
            container.innerHTML = '';
            for(let i=0; i<5; i++) {
                container.innerHTML += `
                <div class="cube-wrapper" onclick="window.toggleLock(${i})">
                    <div class="cube" id="die-${i}">
                        <div class="face front face-1"><div class="dot"></div></div>
                        <div class="face back face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face right face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face left face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face top face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="face bottom face-2"><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>`;
            }
        }

        function syncMultiplayerUI(data, playerList) {
            const gameState = data.gameState;
            const safeIndex = data.currentTurnIndex % playerList.length;
            const currentPlayer = playerList[safeIndex];
            if(!currentPlayer) return;

            isMyTurn = (currentPlayer.nickname === myNickname);
            
            document.getElementById('turn-indicator').innerText = isMyTurn ? "è¼ªåˆ°ä½ äº†ï¼" : `ç­‰å¾… ${currentPlayer.nickname}...`;
            document.getElementById('turn-indicator').style.background = isMyTurn ? '#10b981' : '#0f172a';
            document.getElementById('turn-indicator').style.borderColor = isMyTurn ? '#10b981' : '#334155';
            
            document.getElementById('ingame-players-bar').innerHTML = playerList.map(p => 
                `<div class="player-badge ${p.nickname===currentPlayer.nickname?'active-turn':''} ${p.nickname===myNickname?'is-me':''}">
                    ${p.nickname}: ${p.score}
                </div>`
            ).join('');

            updateDiceVisuals(gameState.dice, gameState.isRolling, gameState.locked);
            // This will now reflect the custom rolls left
            document.getElementById('rolls-left').innerText = gameState.rollsLeft;
            
            const rollBtn = document.getElementById('roll-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;

            if(isMyTurn) {
                rollBtn.disabled = (!isInfinite && gameState.rollsLeft <= 0) || gameState.isRolling;
                if(!localSelection) confirmBtn.disabled = true;
            } else {
                rollBtn.disabled = true;
                confirmBtn.disabled = true;
                localSelection = null;
            }

            renderScoreTables(playerList.map(p => ({...p, isMe: p.nickname===myNickname})));
        }

        window.handleRollClick = () => {
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            
            // Get override values if admin
            const getRollValue = (idx) => {
                if(isAdmin) {
                    const v = parseInt(document.getElementById(`admin-d${idx}`).value);
                    if(v>=1 && v<=6) return v;
                }
                return Math.floor(Math.random()*6)+1;
            };

            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                if(!isInfinite && soloState.rollsLeft <= 0) return;
                if(soloState.isRolling) return;
                
                soloState.isRolling = true;
                updateDiceVisuals(soloState.dice, true, soloState.locked);
                
                setTimeout(() => {
                    const newDice = [...soloState.dice];
                    for(let i=0; i<5; i++) if(!soloState.locked[i]) newDice[i] = getRollValue(i);
                    soloState.dice = newDice;
                    if(!isInfinite) soloState.rollsLeft--;
                    soloState.isRolling = false;
                    
                    updateDiceVisuals(soloState.dice, false, soloState.locked);
                    document.getElementById('rolls-left').innerText = soloState.rollsLeft;
                    document.getElementById('roll-btn').disabled = (!isInfinite && soloState.rollsLeft <= 0);
                    localSelection = null; document.getElementById('confirm-btn').disabled = true;
                }, 600);
            } 
            else if(currentGameMode === 'multiplayer' && isMyTurn) {
                const state = currentRoomData.gameState;
                if(!isInfinite && state.rollsLeft <= 0) return;
                if(state.isRolling) return;
                
                update(ref(db, `${ROOMS_ROOT}/${currentRoomId}/gameState`), { isRolling: true });
                const newDice = [...state.dice];
                for(let i=0; i<5; i++) if(!state.locked[i]) newDice[i] = getRollValue(i);
                
                setTimeout(() => {
                    update(ref(db, `${ROOMS_ROOT}/${currentRoomId}/gameState`), {
                        dice: newDice, rollsLeft: isInfinite? state.rollsLeft : state.rollsLeft-1, isRolling: false
                    });
                }, 800);
            }
        };

        window.toggleLock = (index) => {
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            if(currentGameMode === 'view_record') return;

            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                // Solo default check
                if(!isInfinite && soloState.rollsLeft === 3) return; 
                if(soloState.isRolling) return;
                soloState.locked[index] = !soloState.locked[index];
                updateDiceVisuals(soloState.dice, false, soloState.locked);
            } else if (currentGameMode === 'multiplayer' && isMyTurn) {
                 const state = currentRoomData.gameState;
                 const maxRolls = currentRoomData.config?.maxRolls || 3;
                 // Only prevent locking if we haven't rolled yet (rollsLeft equals maxRolls)
                 if(!isInfinite && state.rollsLeft === maxRolls) return;
                 if(state.isRolling) return;
                 const newLocked = [...state.locked];
                 newLocked[index] = !newLocked[index];
                 update(ref(db, `${ROOMS_ROOT}/${currentRoomId}/gameState`), { locked: newLocked });
            }
        };

        window.handleScoreSelect = (type, key) => {
            if(currentGameMode === 'view_record') return;
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            
            let state, board;
            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                state = soloState; board = soloState.board;
            } else {
                if(!isMyTurn) return;
                state = currentRoomData.gameState;
                board = currentRoomData.players[myPlayerId].board || {};
            }

            // Logic: Prevent selection if haven't rolled at least once
            let maxRolls = 3;
            if(currentGameMode === 'multiplayer') maxRolls = currentRoomData.config?.maxRolls || 3;

            if(!isInfinite && state.rollsLeft === maxRolls && state.dice[0] === 1 && !localSelection) return;
            if(state.isRolling) return;

            let cellId = (type==='upper') ? `s${key}` : `s-${key}`;
            if(board[cellId] !== undefined) return;

            let score = calculateScore(type, key, state.dice);
            
            // Clear prev
            if(localSelection && document.getElementById(localSelection.cellId)) {
                document.getElementById(localSelection.cellId).innerText = '-';
                document.getElementById(localSelection.cellId).classList.remove('preview-text');
                document.getElementById(localSelection.cellId).closest('tr').classList.remove('selected-row');
            }

            localSelection = { type, key, score, cellId };
            const cell = document.getElementById(cellId);
            cell.innerText = score;
            cell.classList.add('preview-text');
            cell.closest('tr').classList.add('selected-row');
            document.getElementById('confirm-btn').disabled = false;
        };

        window.handleConfirmClick = async () => {
            if(!localSelection) return;
            const { cellId, score, key } = localSelection;
            const isInfinite = isAdmin && document.getElementById('admin-infinite-rolls').checked;
            
            let dice, currentYahtzeeScore = 0;
            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                dice = soloState.dice;
                currentYahtzeeScore = soloState.board['s-yahtzee'] || 0;
            } else {
                dice = currentRoomData.gameState.dice;
                // Safe check for board existance
                const pBoard = currentRoomData.players[myPlayerId].board || {};
                currentYahtzeeScore = pBoard['s-yahtzee'] || 0;
            }

            // Yahtzee Logic
            const isYahtzeeRoll = dice.every(d => d === dice[0]);
            let bonusToAdd = 0;

            if(currentGameMode === 'solo' || currentGameMode === 'challenge') {
                // Solo/Challenge default is Bonus ON
                bonusToAdd = (isYahtzeeRoll && currentYahtzeeScore >= 50) ? 100 : 0;
                
                if(isPrimaryYahtzee(key, score)) showOverlay("YAHTZEE!", "æ¼‚äº®ï¼", true, 3000);
                if(bonusToAdd > 0) {
                    showOverlay("BONUS YAHTZEE!", "+100 åˆ†ï¼", true, 3000);
                    soloState.board['s-yahtzee'] = currentYahtzeeScore + bonusToAdd;
                }
                
                soloState.board[cellId] = score;
                soloState.score = calculateRealScore(soloState.board);
                
                // Reset Round
                soloState.dice = [1,1,1,1,1];
                soloState.locked = [false,false,false,false,false];
                soloState.rollsLeft = 3;
                
                // UI Update
                renderScoreTables([{ nickname: myNickname, score: soloState.score, board: soloState.board, isMe: true }]);
                updateDiceVisuals(soloState.dice, false, soloState.locked);
                document.getElementById('rolls-left').innerText = "3";
                document.getElementById('roll-btn').disabled = false;
                localSelection = null;
                document.getElementById('confirm-btn').disabled = true;
                
                if(isAdmin) document.querySelectorAll('.admin-die-input').forEach(el => el.value = "");
                
                checkGameOver([{ board: soloState.board, nickname: myNickname }]);
            } 
            else if(currentGameMode === 'multiplayer') {
                const configBonus = (currentRoomData.config?.allowBonusYahtzee !== false); // Default true
                const configRolls = currentRoomData.config?.maxRolls || 3;

                bonusToAdd = (isYahtzeeRoll && currentYahtzeeScore >= 50 && configBonus) ? 100 : 0;
                let isPrimary = (key === 'yahtzee' && score === 50);

                const roomId = currentRoomId;
                const updates = {};
                updates[`${ROOMS_ROOT}/${roomId}/players/${myPlayerId}/board/${cellId}`] = score;
                if(bonusToAdd > 0) updates[`${ROOMS_ROOT}/${roomId}/players/${myPlayerId}/board/s-yahtzee`] = currentYahtzeeScore + bonusToAdd;
                
                // Calc Score
                const newBoard = { ...(currentRoomData.players[myPlayerId].board || {}), [cellId]: score };
                if(bonusToAdd > 0) newBoard['s-yahtzee'] = currentYahtzeeScore + bonusToAdd;
                const newTotal = calculateRealScore(newBoard);
                updates[`${ROOMS_ROOT}/${roomId}/players/${myPlayerId}/score`] = newTotal;

                if(isPrimary || bonusToAdd > 0) {
                     updates[`${ROOMS_ROOT}/${roomId}/lastEvent`] = { type: 'YAHTZEE', nickname: myNickname + (bonusToAdd?" (+100)":""), id: Date.now() };
                }

                // Turn pass
                const pIds = Object.keys(currentRoomData.players).sort(); 
                const nextTurn = (currentRoomData.currentTurnIndex + 1) % pIds.length;
                
                updates[`${ROOMS_ROOT}/${roomId}/currentTurnIndex`] = nextTurn;
                // Reset to custom config rolls
                updates[`${ROOMS_ROOT}/${roomId}/gameState`] = { dice: [1,1,1,1,1], locked: [false,false,false,false,false], rollsLeft: configRolls, isRolling: false };
                
                await update(ref(db), updates);
                localSelection = null; document.getElementById('confirm-btn').disabled = true;
                if(isAdmin) document.querySelectorAll('.admin-die-input').forEach(el => el.value = "");
            }
        };
        
        function isPrimaryYahtzee(key, score) {
            return key === 'yahtzee' && score === 50;
        }

        // --- 6. Helper Functions ---

        function updateDiceVisuals(values, isRolling, lockedStatus) {
            for(let i=0; i<5; i++) {
                const dieElem = document.getElementById(`die-${i}`);
                const wrapper = document.querySelectorAll('.cube-wrapper')[i];
                if(lockedStatus[i]) wrapper.classList.add('locked'); else wrapper.classList.remove('locked');
                
                if(isRolling && !lockedStatus[i]) {
                    dieElem.style.transform = `rotateX(${Math.random()*720}deg) rotateY(${Math.random()*720}deg)`;
                } else {
                    let x=0, y=0;
                    switch(values[i]) {
                        case 1: x=0; y=0; break; case 2: x=90; y=0; break; case 3: x=0; y=-90; break;
                        case 4: x=0; y=90; break; case 5: x=-90; y=0; break; case 6: x=0; y=180; break;
                    }
                    dieElem.style.transform = `rotateX(${x}deg) rotateY(${y}deg)`;
                }
            }
        }

        function calculateRealScore(board) {
            if(!board) return 0;
            let uSum=0; for(let k=1; k<=6; k++) if(board[`s${k}`]) uSum+=board[`s${k}`];
            let bonus = uSum>=63 ? 35 : 0;
            let lSum=0;
            ['s-3ok','s-4ok','s-full','s-sm-str','s-lg-str','s-yahtzee','s-chance'].forEach(k => { if(board[k]) lSum+=board[k]; });
            return uSum + bonus + lSum;
        }

        function renderScoreTables(players) {
            const upper = document.getElementById('upper-section');
            const lower = document.getElementById('lower-section');
            let header = `<tr><th class="icon-col"></th>` + players.map(p=>`<th class="player-header ${p.isMe?'is-me-header':''}">${p.nickname}</th>`).join('') + `</tr>`;
            
            // Upper
            let uHTML = header;
            for(let i=1; i<=6; i++) {
                uHTML += `<tr class="score-row" onclick="window.handleScoreSelect('upper', ${i})">
                    <td class="icon-col"><div class="mini-die m-d-${i}">${Array(i).fill('<div class="mini-dot"></div>').join('')}</div></td>
                    ${players.map(p => {
                        // FIX: Safely handle if p.board is undefined (Firebase removes empty objects)
                        const b = p.board || {}; 
                        const val = (b[`s${i}`] !== undefined) ? b[`s${i}`] : '-';
                        return `<td ${p.isMe?`id="s${i}"`:''} class="score-cell ${p.isMe?'my-cell':''} ${val!=='-'?'filled':''}">${val}</td>`;
                    }).join('')}
                </tr>`;
            }
            // Bonus Row (CRITICAL FIX WAS HERE)
            uHTML += `<tr style="background:rgba(0,0,0,0.2);height:28px;"><td class="icon-col" style="color:#64748b;font-size:0.7rem;font-weight:bold;">ç</td>
                ${players.map(p => {
                    let s=0; 
                    const b = p.board || {}; // CRITICAL FIX: Default to empty object if board is missing
                    for(let k=1;k<=6;k++) if(b[`s${k}`]) s+=b[`s${k}`];
                    return `<td class="score-cell" style="color:${s>=63?'#10b981':'#94a3b8'};font-size:0.75rem;">${s>=63?'35':`${s}/63`}</td>`;
                }).join('')}
            </tr>`;
            upper.innerHTML = uHTML;

            // Lower
            let lHTML = header;
            const cats = [{k:'3ok',n:'3X'},{k:'4ok',n:'4X'},{k:'full',n:'ğŸ '},{k:'sm-str',n:'å°é †'},{k:'lg-str',n:'å¤§é †'},{k:'yahtzee',n:'Y!'},{k:'chance',n:'?'}];
            cats.forEach(c => {
                lHTML += `<tr class="score-row" onclick="window.handleScoreSelect('lower', '${c.k}')">
                    <td class="symbol-text icon-col">${c.n}</td>
                    ${players.map(p => {
                        const b = p.board || {};
                        const val = (b[`s-${c.k}`] !== undefined) ? b[`s-${c.k}`] : '-';
                        return `<td ${p.isMe?`id="s-${c.k}"`:''} class="score-cell ${p.isMe?'my-cell':''} ${val!=='-'?'filled':''}">${val}</td>`;
                    }).join('')}
                </tr>`;
            });
            lower.innerHTML = lHTML;

            // Update Total
            const me = players.find(p => p.isMe);
            if(me) document.getElementById('grand-total').innerText = calculateRealScore(me.board || {});
            
            // Restore Preview
            if(localSelection) {
                const c = document.getElementById(localSelection.cellId);
                if(c) { c.innerText=localSelection.score; c.classList.add('preview-text'); c.closest('tr').classList.add('selected-row'); }
            }
        }

        function checkGameOver(players) {
            const me = players.find(p => p.nickname === myNickname); 
            // Check if I finished (13 entries)
            // Fix: Check if board exists
            if(me && me.board && Object.keys(me.board).length >= 13) {
                const finalScore = calculateRealScore(me.board);
                
                if(currentGameMode === 'challenge') {
                    // Upload Score
                    showOverlay("æŒ‘æˆ°çµæŸ", `å¾—åˆ†: ${finalScore}`, true, 0);
                    
                    // Push to Leaderboard
                    push(ref(db, `${CHALLENGE_ROOT}/${currentChallengeRoomId}/leaderboard`), {
                        nickname: myNickname,
                        score: finalScore,
                        board: me.board,
                        timestamp: Date.now()
                    });
                    
                    // Change Overlay button behavior
                    setTimeout(() => {
                        const exitBtn = document.getElementById('overlay-exit-btn');
                        if(exitBtn) {
                            exitBtn.innerText = "å›åˆ°æ¦œå–®";
                            exitBtn.onclick = () => {
                                document.getElementById('special-event-overlay').classList.remove('active');
                                showView('challenge-room-detail');
                            };
                        }
                    }, 100);

                } else if (currentGameMode === 'solo') {
                    showOverlay("éŠæˆ²çµæŸ", `å¾—åˆ†: ${finalScore}`, true, 0);
                } else {
                    // Multiplayer: Check everyone
                    // Fix: Check if board exists for everyone
                    if(players.every(p => p.board && Object.keys(p.board).length >= 13)) {
                        let winner = players[0]; let max = -1;
                        players.forEach(p => { 
                            let s = calculateRealScore(p.board || {}); 
                            if(s>max){max=s; winner=p;} 
                        });
                        showOverlay("æ­å–œç²å‹ï¼", `${winner.nickname} ä»¥ ${max} åˆ†ç²å‹ï¼`, true, 0);
                    }
                }
            }
        }

        function showOverlay(title, sub, rainbow, duration) {
            const ov = document.getElementById('special-event-overlay');
            document.getElementById('overlay-title').innerText = title;
            document.getElementById('overlay-sub').innerText = sub;
            if(rainbow) ov.classList.add('rainbow-bg'); else ov.classList.remove('rainbow-bg');
            ov.classList.add('active');
            
            // Cleanup old
            document.querySelectorAll('.confetti').forEach(e=>e.remove());
            const oldBtn = document.getElementById('overlay-exit-btn'); if(oldBtn) oldBtn.remove();

            // Confetti
            for(let i=0;i<50;i++){
                const c = document.createElement('div'); c.className='confetti';
                c.style.left=Math.random()*100+'%'; c.style.backgroundColor=`hsl(${Math.random()*360},70%,50%)`;
                c.style.animationDuration=(2+Math.random()*2)+'s';
                ov.appendChild(c);
            }

            if(duration === 0) {
                const btn = document.createElement('button');
                btn.id = 'overlay-exit-btn';
                btn.className = 'menu-btn primary';
                btn.style.marginTop = '30px'; btn.style.pointerEvents='auto';
                btn.innerText = 'å›åˆ°é¦–é ';
                btn.onclick = () => location.reload();
                ov.appendChild(btn);
            } else {
                setTimeout(() => { ov.classList.remove('active'); }, duration);
            }
        }
        
        function calculateScore(type, key, dice) {
            if (type === 'upper') return dice.filter(d => d === key).length * key;
            const counts = {}; dice.forEach(x => counts[x] = (counts[x]||0)+1);
            const vals = Object.values(counts);
            const sum = dice.reduce((a,b)=>a+b,0);
            const uniq = [...new Set(dice)].sort((a,b)=>a-b);
            const isSeq = (n) => {
                let max=1, cur=1; 
                for(let i=0;i<uniq.length-1;i++) { if(uniq[i+1]===uniq[i]+1) cur++; else cur=1; if(cur>max) max=cur; }
                return max >= n;
            };

            switch(key) {
                case '3ok': return vals.some(c=>c>=3) ? sum : 0;
                case '4ok': return vals.some(c=>c>=4) ? sum : 0;
                case 'full': return (vals.includes(3)&&vals.includes(2)) || vals.includes(5) ? 25 : 0;
                case 'sm-str': return isSeq(4) ? 30 : 0;
                case 'lg-str': return isSeq(5) ? 40 : 0;
                case 'yahtzee': return vals.includes(5) ? 50 : 0;
                case 'chance': return sum;
                default: return 0;
            }
        }

        // --- Enhanced Admin Logic ---

        window.adminDeleteRoom = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤æˆ¿é–“ï¼Ÿ")) remove(ref(db,`${ROOMS_ROOT}/${id}`)); };
        
        window.adminForceStart = async (id) => {
             if(confirm("å¼·åˆ¶é–‹å§‹éŠæˆ²ï¼Ÿ")) update(ref(db, `${ROOMS_ROOT}/${id}`), { status: 'playing' });
        };
        
        window.adminResetTurn = async (id) => {
             // Emergency fix if turn gets stuck
             if(confirm("é‡ç½®å›åˆéª°å­ï¼Ÿ")) update(ref(db, `${ROOMS_ROOT}/${id}/gameState`), { rollsLeft: 3, isRolling: false, locked: [false,false,false,false,false] });
        };

        window.showAdminRoomManager = () => {
             showView('admin-room-view');
             onValue(ref(db, ROOMS_ROOT), snap => {
                 const list = document.getElementById('admin-room-list'); list.innerHTML='';
                 const d = snap.val(); 
                 if(!d) { list.innerHTML = "<div style='color:#777'>ç›®å‰æ²’æœ‰æ´»èºæˆ¿é–“</div>"; return; }
                 
                 // Sort by newest first
                 const rooms = Object.values(d).reverse();
                 
                 rooms.forEach(r => {
                     const players = r.players ? Object.values(r.players) : [];
                     const pCount = players.length;
                     const pNames = players.map(p => `${p.nickname}(${p.score||0})`).join(', ');
                     const lastEvt = r.lastEvent ? `Event: ${r.lastEvent.type} by ${r.lastEvent.nickname}` : '';

                     list.innerHTML += `
                     <div class="admin-room-card" style="background:var(--panel-bg); border-left:4px solid var(--admin-color); padding:15px; margin-bottom:12px; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; color:var(--text-color);">${r.host} çš„æˆ¿é–“</span>
                            <span style="font-size:0.8rem; background:${r.status==='playing'?'#10b981':'#d97706'}; color:white; padding:2px 8px; border-radius:4px;">${r.status}</span>
                        </div>
                        <div style="font-size:0.85rem; color:#94a3b8; line-height:1.5;">
                            ID: <span style="font-family:monospace">${r.id}</span><br>
                            ç©å®¶ (${pCount}/${r.maxPlayers}): ${pNames}<br>
                            å›åˆ: ${r.currentTurnIndex || 0} | å‰©é¤˜æ“²éª°: ${r.gameState?.rollsLeft}<br>
                            è¨­å®š: ${r.config?.maxRolls||3}éª° | ${r.config?.allowBonusYahtzee!==false?'+100é–‹':'+100é—œ'}<br>
                            ${lastEvt ? `<span style="color:#fbbf24">${lastEvt}</span>` : ''}
                        </div>
                        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
                            <button class="action-btn join-btn" onclick="window.adminForceStart('${r.id}')">å¼·åˆ¶é–‹å§‹</button>
                            <button class="action-btn warn-btn" onclick="window.adminResetTurn('${r.id}')">é‡ç½®å›åˆ</button>
                            <button class="action-btn delete-btn" onclick="window.adminDeleteRoom('${r.id}')">åˆªé™¤</button>
                        </div>
                     </div>`;
                 });
             });
        }

    </script>
</body>
</html>
